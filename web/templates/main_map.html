<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE DYING LANDS - HEXCRAWL</title>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=VT323&display=swap" rel="stylesheet">
    <style>
    /* MÖRK BORG STYLING - BRUTALIST APOCALYPTIC DESIGN */
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        background: #000000;
        color: #FFFFFF;
        font-family: 'VT323', monospace;
        font-size: 16px;
        line-height: 1.4;
        overflow-x: hidden;
        position: relative;
    }
    
    /* DISTRESSED BACKGROUND EFFECT */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 80%, rgba(255, 255, 0, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 165, 0, 0.1) 0%, transparent 50%),
            repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255, 255, 255, 0.02) 2px,
                rgba(255, 255, 255, 0.02) 4px
            );
        pointer-events: none;
        z-index: -1;
    }
    
    /* HEADER - BRUTALIST TYPOGRAPHY */
    header {
        background: linear-gradient(90deg, #000000 0%, #1a1a00 50%, #000000 100%);
        border-bottom: 3px solid #FFFF00;
        padding: 20px 0;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 0, 0.3), transparent);
        animation: scan 3s infinite;
    }
    
    @keyframes scan {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    header h1 {
        font-family: 'Special Elite', cursive;
        font-size: 3.5rem;
        font-weight: normal;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: #FFFF00;
        text-shadow: 
            0 0 10px #FFFF00,
            0 0 20px #FFFF00,
            0 0 30px #FFFF00;
        margin: 0;
        position: relative;
        z-index: 1;
    }
    
    header p {
        font-family: 'VT323', monospace;
        font-size: 1.2rem;
        color: #888888;
        margin: 10px 0 0 0;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    
    /* CONTAINER - BRUTALIST LAYOUT */
    .container-fluid {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    /* CONTROL PANEL - INDUSTRIAL DESIGN */
    .control-panel {
        background: #111111;
        border: 2px solid #FFFF00;
        border-radius: 0;
        padding: 20px;
        margin-bottom: 30px;
        position: relative;
        box-shadow: 
            inset 0 0 20px rgba(255, 255, 0, 0.1),
            0 0 20px rgba(255, 255, 0, 0.2);
    }
    
    .control-panel::before {
        content: 'CONTROL INTERFACE';
        position: absolute;
        top: -10px;
        left: 20px;
        background: #000000;
        color: #FFFF00;
        font-family: 'VT323', monospace;
        font-size: 0.8rem;
        padding: 0 10px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    
    /* BUTTONS - BRUTALIST STYLE */
    .btn {
        font-family: 'VT323', monospace;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border: 2px solid;
        border-radius: 0;
        padding: 10px 20px;
        margin: 5px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        background: #000000;
        color: #FFFFFF;
    }
    
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn:hover::before {
        left: 100%;
    }
    
    .btn-warning {
        border-color: #FFA500;
        color: #FFA500;
    }
    
    .btn-warning:hover {
        background: #FFA500;
        color: #000000;
        box-shadow: 0 0 20px rgba(255, 165, 0, 0.5);
    }
    
    .btn-info {
        border-color: #00FFFF;
        color: #00FFFF;
    }
    
    .btn-info:hover {
        background: #00FFFF;
        color: #000000;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }
    
    .btn-secondary {
        border-color: #888888;
        color: #888888;
    }
    
    .btn-secondary:hover {
        background: #888888;
        color: #000000;
        box-shadow: 0 0 20px rgba(136, 136, 136, 0.5);
    }
    
    .btn-success {
        border-color: #00FF00;
        color: #00FF00;
    }
    
    .btn-success:hover {
        background: #00FF00;
        color: #000000;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    }
    
    .btn-danger {
        border-color: #FFFF00;
        color: #FFFF00;
    }
    
    .btn-danger:hover {
        background: #FFFF00;
        color: #000000;
        box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
    }
    
    .btn-primary {
        border-color: #0066FF;
        color: #0066FF;
    }
    
    .btn-primary:hover {
        background: #0066FF;
        color: #FFFFFF;
        box-shadow: 0 0 20px rgba(0, 102, 255, 0.5);
    }
    
    /* MAP CONTAINER - TERMINAL STYLE */
    .map-container {
        background: #000000;
        border: 3px solid #FFFF00;
        border-radius: 0;
        padding: 30px;
        margin: 20px 0;
        position: relative;
        box-shadow: 
            inset 0 0 30px rgba(255, 255, 0, 0.1),
            0 0 30px rgba(255, 255, 0, 0.3);
    }
    
    .map-container::before {
        content: 'HEX GRID TERMINAL';
        position: absolute;
        top: -15px;
        left: 30px;
        background: #000000;
        color: #FFFF00;
        font-family: 'VT323', monospace;
        font-size: 0.9rem;
        padding: 0 15px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    
    /* HEX GRID - RETRO TERMINAL */
    .hex-grid {
        font-family: 'VT323', monospace;
        font-size: 12px;
        line-height: 1.2;
        overflow: auto;
        max-height: 70vh;
        background: #000000;
        padding: 20px;
        border: 1px solid #333333;
        text-align: center;
        white-space: nowrap;
        position: relative;
    }
    
    .hex-grid::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            repeating-linear-gradient(
                0deg,
                transparent,
                transparent 1px,
                rgba(255, 255, 0, 0.1) 1px,
                rgba(255, 255, 0, 0.1) 2px
            );
        pointer-events: none;
    }
    
    /* HEX CELLS - INTERACTIVE TERMINAL */
    .hex-cell {
        cursor: pointer;
        padding: 2px 3px;
        border: 1px solid transparent;
        transition: all 0.2s ease;
        display: inline-block;
        width: 18px;
        text-align: center;
        margin-right: 0px;
        position: relative;
        font-weight: bold;
    }
    
    .hex-cell:hover {
        background-color: rgba(255, 255, 0, 0.3);
        border-color: #FFFF00;
        transform: scale(1.3);
        box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        z-index: 10;
    }
    
    /* TERRAIN COLORS - APOCALYPTIC PALETTE */
    .terrain-mountain { 
        color: #8B4513; 
        text-shadow: 0 0 5px rgba(139, 69, 19, 0.5);
    }
    .terrain-forest { 
        color: #228B22; 
        text-shadow: 0 0 5px rgba(34, 139, 34, 0.5);
    }
    .terrain-coast { 
        color: #4169E1; 
        text-shadow: 0 0 5px rgba(65, 105, 225, 0.5);
    }
    .terrain-plains { 
        color: #DAA520; 
        text-shadow: 0 0 5px rgba(218, 165, 32, 0.5);
    }
    .terrain-swamp { 
        color: #556B2F; 
        text-shadow: 0 0 5px rgba(85, 107, 47, 0.5);
    }
    .terrain-unknown { 
        color: #696969; 
        text-shadow: 0 0 5px rgba(105, 105, 105, 0.5);
    }
    
    /* MAJOR CITIES - GLOWING BEACONS */
    .major-city {
        color: #FFD700 !important;
        font-weight: bold;
        text-shadow: 
            0 0 10px #FFD700,
            0 0 20px #FFD700,
            0 0 30px #FFD700;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .has-content {
        font-weight: bold;
        opacity: 1;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .no-content {
        opacity: 0.5;
    }
    
    /* CITY CARDS - BRUTALIST CARDS */
    .city-card {
        background: #111111;
        border: 2px solid #FFFF00;
        border-radius: 0;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .city-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 0, 0.1), transparent);
        transition: left 0.5s;
    }
    
    .city-card:hover::before {
        left: 100%;
    }
    
    .city-card:hover {
        transform: translateY(-3px);
        box-shadow: 
            0 5px 15px rgba(255, 255, 0, 0.3),
            0 0 30px rgba(255, 255, 0, 0.2);
        border-color: #FFA500;
    }
    
    .city-card .card-body {
        padding: 15px;
        background: #000000;
    }
    
    .city-card .card-title {
        font-family: 'Special Elite', cursive;
        color: #FFFF00;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 5px;
    }
    
    /* MODALS - BRUTALIST OVERLAYS */
    .modal {
        display: none;
    }
    
    .modal.show {
        display: block;
    }
    
    .modal-content {
        background: #000000;
        color: #FFFFFF;
        border: 3px solid #FFFF00;
        border-radius: 0;
        box-shadow: 
            0 0 50px rgba(255, 255, 0, 0.5),
            inset 0 0 30px rgba(255, 255, 0, 0.1);
    }
    
    .modal-header {
        border-bottom: 2px solid #FFFF00;
        background: #111111;
        padding: 20px;
    }
    
    .modal-header .modal-title {
        font-family: 'Special Elite', cursive;
        color: #FFFF00;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    
    .modal-body {
        padding: 30px;
        background: #000000;
        font-family: 'VT323', monospace;
        font-size: 1.1rem;
        line-height: 1.6;
    }
    
    .modal-footer {
        border-top: 2px solid #FFFF00;
        background: #111111;
        padding: 20px;
    }
    
    /* BADGES - TERMINAL STYLE */
    .badge {
        font-family: 'VT323', monospace;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border: 1px solid;
        border-radius: 0;
        padding: 5px 10px;
        background: #000000;
    }
    
    .bg-info {
        border-color: #00FFFF;
        color: #00FFFF;
    }
    
    .bg-secondary {
        border-color: #888888;
        color: #888888;
    }
    
    .bg-warning {
        border-color: #FFA500;
        color: #FFA500;
    }
    
    .bg-danger {
        border-color: #FFFF00;
        color: #FFFF00;
    }
    
    .bg-primary {
        border-color: #0066FF;
        color: #0066FF;
    }
    
    .bg-success {
        border-color: #00FF00;
        color: #00FF00;
    }
    
    /* LEGEND - TERMINAL STYLE */
    .legend {
        background: #111111;
        border: 2px solid #FFFF00;
        border-radius: 0;
        padding: 20px;
        font-family: 'VT323', monospace;
        font-size: 1rem;
        position: relative;
        margin-top: 30px;
    }
    
    .legend::before {
        content: 'LEGEND';
        position: absolute;
        top: -10px;
        left: 20px;
        background: #000000;
        color: #FFFF00;
        font-family: 'VT323', monospace;
        font-size: 0.8rem;
        padding: 0 10px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    
    .legend h6 {
        font-family: 'Special Elite', cursive;
        color: #FFFF00;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 15px;
    }
    
    /* MAP ROWS - TERMINAL LAYOUT */
    .map-row {
        display: block;
        text-align: left;
        margin: 0 auto;
        width: fit-content;
        position: relative;
    }
    
    .row-number {
        display: inline-block;
        width: 35px;
        text-align: right;
        margin-right: 10px;
        color: #666666;
        font-family: 'VT323', monospace;
        font-size: 0.9rem;
    }
    
    /* ALERTS - BRUTALIST NOTIFICATIONS */
    .alert {
        font-family: 'VT323', monospace;
        border: 2px solid;
        border-radius: 0;
        padding: 15px;
        margin: 15px 0;
        background: #000000;
    }
    
    .alert-info {
        border-color: #00FFFF;
        color: #00FFFF;
    }
    
    .alert-success {
        border-color: #00FF00;
        color: #00FF00;
    }
    
    .alert-danger {
        border-color: #FFFF00;
        color: #FFFF00;
    }
    
    .alert-warning {
        border-color: #FFA500;
        color: #FFA500;
    }
    
    /* CARDS - BRUTALIST STYLE */
    .card {
        background: #111111;
        border: 2px solid #333333;
        border-radius: 0;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .card:hover {
        border-color: #FFFF00;
        box-shadow: 0 0 20px rgba(255, 255, 0, 0.2);
    }
    
    .card-body {
        padding: 15px;
        background: #000000;
    }
    
    .card-title {
        font-family: 'Special Elite', cursive;
        color: #FFFF00;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    
    /* TEXT UTILITIES */
    .text-muted {
        color: #888888 !important;
    }
    
    .text-warning {
        color: #FFA500 !important;
    }
    
    .text-danger {
        color: #FFF000 !important;
    }
    
    .text-success {
        color: #00FF00 !important;
    }
    
    .text-info {
        color: #00FFFF !important;
    }
    
    /* PRE ELEMENTS - TERMINAL STYLE */
    pre {
        background: #000000;
        color: #00FF00;
        border: 1px solid #00FF00;
        border-radius: 0;
        padding: 15px;
        font-family: 'VT323', monospace;
        font-size: 0.9rem;
        line-height: 1.3;
        overflow: auto;
        position: relative;
    }
    
    pre::before {
        content: 'TERMINAL OUTPUT';
        position: absolute;
        top: -10px;
        left: 10px;
        background: #000000;
        color: #00FF00;
        font-family: 'VT323', monospace;
        font-size: 0.7rem;
        padding: 0 8px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    
    /* RESPONSIVE DESIGN */
    @media (max-width: 768px) {
        header h1 {
            font-size: 2.5rem;
        }
        
        .container-fluid {
            padding: 10px;
        }
        
        .hex-grid {
            font-size: 10px;
        }
        
        .hex-cell {
            width: 16px;
        }
    }
    
    /* SCROLLBAR STYLING */
    ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }
    
    ::-webkit-scrollbar-track {
        background: #000000;
        border: 1px solid #333333;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #FFF000;
        border: 1px solid #000000;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #FFA500;
    }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header>
            <h1>THE DYING LANDS</h1>
            <p>HEX MAP TERMINAL - {{ map_width }}×{{ map_height }} ({{ total_hexes }} HEXES)</p>
        </header>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="row">
                <div class="col-md-8">
                    <div class="btn-group me-2" role="group">
                        <button class="btn btn-warning btn-sm" onclick="showTerrainOverview()">🗺️ TERRAIN</button>
                        <button class="btn btn-info btn-sm" onclick="showLoreOverview()">📜 LORE</button>
                        <button class="btn btn-secondary btn-sm" onclick="showLegend()">🗂️ LEGEND</button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-success btn-sm" onclick="generateFullMap()">⚡ GENERATE ALL</button>
                        <button class="btn btn-danger btn-sm" onclick="resetContinent()">🔄 RESET CONTINENT</button>
                        <button class="btn btn-primary btn-sm" onclick="zoomIn()">🔍+</button>
                        <button class="btn btn-primary btn-sm" onclick="zoomOut()">🔍-</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">
                        CLICK HEXES TO VIEW/GENERATE CONTENT<br>
                        <span class="major-city">◆</span> = MAJOR CITIES
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Major Cities Overview -->
        <div class="row mb-3" style="display: none;">
            <div class="col-12">
                <h5>🏰 MAJOR CITIES</h5>
                <div class="row">
                    {% for city in major_cities %}
                    <div class="col-md-4 col-lg-3">
                        <div class="city-card card" onclick="showCityDetails('{{ city.hex_code }}')">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">{{ city.name }}</h6>
                                <small class="text-muted">
                                    {{ city.hex_code }} - {{ city.region.title() }}<br>
                                    POP: {{ city.population }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- ASCII Map -->
        <div class="map-container">
            <div class="hex-grid" id="map-grid">
                <!-- Column headers -->
                <div class="text-center mb-2">
                    <span style="margin-right: 20px;"></span>
                    {% for x in range(1, map_width + 1) %}
                        {% if x <= 9 %}
                            <span style="margin-right: 4px; font-size: 9px; display: inline-block; width: 12px; text-align: center;">0{{ x }}</span>
                        {% else %}
                            <span style="margin-right: 4px; font-size: 9px; display: inline-block; width: 12px; text-align: center;">{{ x }}</span>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Map rows -->
                {% for y in range(1, map_height + 1) %}
                <div class="map-row">
                    <span class="row-number">{{ "%02d"|format(y) }}</span>
                    {% for x in range(1, map_width + 1) %}
                        {% set hex_code = "%02d%02d"|format(x, y) %}
                        {% set hex_data = ascii_map[hex_code] %}
                        <span class="hex-cell {{ hex_data.css_class }} {{ 'has-content' if hex_data.has_content else 'no-content' }}"
                              onclick="showHexDetails('{{ hex_code }}')"
                              title="HEX {{ hex_code }}{% if hex_data.is_city %} - {{ hex_data.city_name }}{% endif %}">{{ hex_data.symbol }}</span>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Legend -->
        <div class="legend" id="legend">
            <h6>🗂️ MAP LEGEND</h6>
            <div class="row">
                <div class="col-md-6">
                    <strong>TERRAIN:</strong><br>
                    <span class="terrain-mountain">^</span> MOUNTAIN &nbsp;
                    <span class="terrain-forest">♠</span> FOREST &nbsp;
                    <span class="terrain-coast">~</span> COAST<br>
                    <span class="terrain-plains">.</span> PLAINS &nbsp;
                    <span class="terrain-swamp">#</span> SWAMP
                </div>
                <div class="col-md-6">
                    <strong>LOCATIONS:</strong><br>
                    <span class="major-city">◆</span> MAJOR CITIES<br>
                    <strong>BOLD</strong> = HAS CONTENT
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hex Details Modal -->
    <div class="modal fade" id="hexModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hexModalTitle">HEX DETAILS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="hexModalBody">
                    LOADING...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CLOSE</button>
                    <button type="button" class="btn btn-primary" onclick="generateHexContent()">GENERATE CONTENT</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- City Details Modal -->
    <div class="modal fade" id="cityModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cityModalTitle">CITY DETAILS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="cityModalBody">
                    LOADING...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CLOSE</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Terrain Overview Modal -->
    <div class="modal fade" id="terrainModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">🗺️ TERRAIN OVERVIEW</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="terrainModalBody">
                    LOADING...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lore Overview Modal -->
    <div class="modal fade" id="loreModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">📜 MÖRK BORG LORE</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="loreModalBody">
                    LOADING...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let currentHex = '';
    let mapZoom = 1;
    
    function showHexDetails(hexCode) {
        currentHex = hexCode;
        
        fetch(`/api/hex/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('hexModalTitle').textContent = data.title;
                
                if (data.is_major_city) {
                    showCityDetails(hexCode);
                    return;
                }
                
                let html = '';
                if (data.exists) {
                    html = data.html || `<p>${data.description || 'NO DESCRIPTION AVAILABLE'}</p>`;
                } else {
                    html = `<p>NO CONTENT GENERATED FOR HEX ${hexCode}</p>`;
                }
                
                document.getElementById('hexModalBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('hexModal')).show();
            })
            .catch(error => {
                console.error('ERROR LOADING HEX:', error);
                document.getElementById('hexModalBody').innerHTML = '<p class="text-danger">ERROR LOADING HEX CONTENT</p>';
                new bootstrap.Modal(document.getElementById('hexModal')).show();
            });
    }
    
    function showCityDetails(hexCode) {
        fetch(`/api/city/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const city = data.city;
                    document.getElementById('cityModalTitle').textContent = city.name;
                    
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>🗺️ CITY MAP</h6>
                                <pre>${data.city_map}</pre>
                            </div>
                            <div class="col-md-6">
                                <h6>🏰 CITY INFORMATION</h6>
                                <p><strong>LOCATION:</strong> HEX ${hexCode} (${city.region.charAt(0).toUpperCase() + city.region.slice(1)})</p>
                                <p><strong>POPULATION:</strong> ${city.population}</p>
                                <p><strong>DESCRIPTION:</strong> ${city.description}</p>
                                <p><strong>ATMOSPHERE:</strong> ${city.atmosphere}</p>
                                
                                <h6 class="mt-3">NOTABLE FEATURES</h6>
                                <ul style="font-size:0.9em;">
                    `;
                    
                    city.notable_features.forEach(feature => {
                        html += `<li>${feature}</li>`;
                    });
                    
                    html += `
                                </ul>
                                
                                <h6 class="mt-3">KEY NPCS</h6>
                                <div class="d-flex flex-wrap gap-2">
                    `;
                    
                    city.key_npcs.forEach(npc => {
                        html += `<span class="badge bg-info">${npc}</span>`;
                    });
                    
                    html += `
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>🏰 REGIONAL NPCS</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                    `;
                    
                    data.regional_npcs.forEach(npc => {
                        html += `<span class="badge bg-secondary">${npc}</span>`;
                    });
                    
                    html += `
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>⚔️ ACTIVE FACTIONS</h6>
                    `;
                    
                    data.factions.forEach(faction => {
                        const influenceColors = {
                            'religious': 'warning',
                            'apocalyptic': 'danger',
                            'political': 'primary',
                            'biological': 'success',
                            'magical': 'info'
                        };
                        const badgeColor = influenceColors[faction.influence] || 'secondary';
                        
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <h6 class="mb-1" style="font-size:0.9em;">${faction.name} <span class="badge bg-${badgeColor}">${faction.influence}</span></h6>
                                    <small class="text-muted">${faction.description}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('cityModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('cityModal')).show();
                } else {
                    alert('ERROR LOADING CITY DETAILS: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR LOADING CITY:', error);
                alert('ERROR LOADING CITY DETAILS');
            });
    }
    
    function generateHexContent() {
        if (!currentHex) return;
        
        fetch('/api/generate-hex', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hex: currentHex })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showHexDetails(currentHex);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                alert('FAILED TO GENERATE CONTENT: ' + data.error);
            }
        })
        .catch(error => {
            console.error('ERROR GENERATING HEX:', error);
            alert('ERROR GENERATING HEX CONTENT');
        });
    }
    
    function generateFullMap() {
        if (confirm('GENERATE CONTENT FOR THE ENTIRE MAP? THIS MAY TAKE A WHILE...')) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '⏳ GENERATING...';
            btn.disabled = true;
            
            fetch('/api/generate-full-map', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`GENERATED ${data.count} HEXES!`);
                    window.location.reload();
                } else {
                    alert('FAILED TO GENERATE MAP: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR GENERATING MAP:', error);
                alert('ERROR GENERATING FULL MAP');
            })
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }
    }
    
    function resetContinent() {
        if (confirm('🚨 RESET ENTIRE CONTINENT? 🚨\n\nTHIS WILL DELETE ALL GENERATED CONTENT AND CREATE A COMPLETELY FRESH MAP.\n\nTHIS ACTION CANNOT BE UNDONE!')) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '🔄 RESETTING...';
            btn.disabled = true;
            
            // Disable all other buttons during reset
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(button => button.disabled = true);
            
            fetch('/api/reset-continent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ ${data.message}`);
                    window.location.reload();
                } else {
                    alert('❌ FAILED TO RESET CONTINENT: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR RESETTING CONTINENT:', error);
                alert('❌ ERROR RESETTING CONTINENT');
            })
            .finally(() => {
                // Re-enable all buttons
                allButtons.forEach(button => button.disabled = false);
                btn.textContent = originalText;
            });
        }
    }
    
    function showTerrainOverview() {
        fetch('/api/terrain-overview')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const [width, height] = data.dimensions;
                    let html = `
                        <div class="row">
                            <div class="col-md-8">
                                <pre>${data.terrain_map}</pre>
                            </div>
                            <div class="col-md-4">
                                <h6>📊 TERRAIN STATISTICS</h6>
                    `;
                    
                    for (const [terrain, count] of Object.entries(data.distribution)) {
                        const percentage = ((count / (width * height)) * 100).toFixed(1);
                        html += `<div class="mb-2">
                            <span class="terrain-${terrain}">${getTerrainSymbol(terrain)}</span>
                            <strong>${terrain.charAt(0).toUpperCase() + terrain.slice(1)}</strong>: 
                            ${count} HEXES (${percentage}%)
                        </div>`;
                    }
                    
                    html += `
                                <hr>
                                <h6>🗺️ MAP INFO</h6>
                                <div class="small">
                                    <strong>DIMENSIONS:</strong> ${width}×${height}<br>
                                    <strong>TOTAL HEXES:</strong> ${width * height}<br>
                                    <strong>LORE INTEGRATION:</strong> ✅ ACTIVE
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('terrainModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('terrainModal')).show();
                } else {
                    alert('ERROR LOADING TERRAIN OVERVIEW: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR LOADING TERRAIN OVERVIEW:', error);
                alert('ERROR LOADING TERRAIN OVERVIEW');
            });
    }
    
    function showLoreOverview() {
        fetch('/api/lore-overview')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>🏰 MAJOR CITIES (${data.major_cities})</h6>
                    `;
                    
                    data.cities_data.forEach(city => {
                        html += `
                            <div class="card mb-2" onclick="showCityDetails('${city.hex_code}')" style="cursor:pointer;">
                                <div class="card-body py-2">
                                    <h6 class="mb-1">${city.name} <span class="badge bg-secondary">${city.hex_code}</span></h6>
                                    <small class="text-muted">${city.region} - ${city.population}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                            <div class="col-md-6">
                                <h6>⚔️ MAJOR FACTIONS (${data.factions})</h6>
                    `;
                    
                    data.factions_data.forEach(faction => {
                        const influenceColors = {
                            'religious': 'warning',
                            'apocalyptic': 'danger',
                            'political': 'primary',
                            'biological': 'success',
                            'magical': 'info'
                        };
                        const badgeColor = influenceColors[faction.influence] || 'secondary';
                        
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <h6 class="mb-1">${faction.name} <span class="badge bg-${badgeColor}">${faction.influence}</span></h6>
                                    <small class="text-muted">ACTIVE IN: ${faction.regions.join(', ')}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="alert alert-info">
                                <strong>🎲 GAME MASTER NOTE:</strong> THIS LORE IS INTEGRATED INTO HEX GENERATION. 
                                CITIES AND FACTIONS INFLUENCE CONTENT IN THEIR REGIONS.
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('loreModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('loreModal')).show();
                } else {
                    alert('ERROR LOADING LORE OVERVIEW: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR LOADING LORE OVERVIEW:', error);
                alert('ERROR LOADING LORE OVERVIEW');
            });
    }
    
    function getTerrainSymbol(terrain) {
        const symbols = {
            'mountain': '^', 'forest': '♠', 'coast': '~',
            'plains': '.', 'swamp': '#', 'unknown': '?'
        };
        return symbols[terrain] || '?';
    }
    
    function zoomIn() {
        mapZoom = Math.min(mapZoom * 1.2, 3);
        applyZoom();
    }
    
    function zoomOut() {
        mapZoom = Math.max(mapZoom / 1.2, 0.5);
        applyZoom();
    }
    
    function applyZoom() {
        const mapElement = document.getElementById('map-grid');
        if (mapElement) {
            mapElement.style.transform = `scale(${mapZoom})`;
            mapElement.style.transformOrigin = 'top left';
        }
    }
    
    function showLegend() {
        document.getElementById('legend').scrollIntoView({ behavior: 'smooth' });
    }
    </script>
</body>
</html>