<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è The Dying Lands - Interactive Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/fonts.css" rel="stylesheet">
    <style>
    :root {
        --mork-black: #000000;
        --mork-cyan: #00FFFF;
        --mork-yellow: #FFFF00;
        --mork-green: #00FF00;
        --mork-magenta: #FF00FF;
        --mork-white: #FFFFFF;
        --mork-orange: #FF8000;
        --mork-gray: #808080;
    }

    body {
        background: var(--mork-black);
        color: var(--mork-white);
        font-family: 'pixelify-sans', monospace;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }
    
    h1, h2, h3, h4, h5, h6 {
        font-family: 'adhesive-nr-seven', serif;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    /* M√∂rk Borg Button Styling */
    .btn-mork-borg {
        background: var(--mork-black);
        border: 2px solid var(--mork-cyan);
        color: var(--mork-cyan);
        font-family: 'adhesive-nr-seven', serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: bold;
        padding: 8px 16px;
        margin: 2px;
        transition: all 0.3s ease;
        border-radius: 0;
        position: relative;
        overflow: hidden;
    }

    .btn-mork-borg:hover {
        background: var(--mork-cyan);
        color: var(--mork-black);
        box-shadow: 0 0 15px var(--mork-cyan);
        transform: translateY(-2px);
    }

    .btn-mork-borg:active {
        transform: translateY(0);
        box-shadow: 0 0 8px var(--mork-cyan);
    }

    .btn-mork-borg.btn-warning {
        border-color: var(--mork-yellow);
        color: var(--mork-yellow);
    }

    .btn-mork-borg.btn-warning:hover {
        background: var(--mork-yellow);
        color: var(--mork-black);
        box-shadow: 0 0 15px var(--mork-yellow);
    }

    .btn-mork-borg.btn-info {
        border-color: var(--mork-green);
        color: var(--mork-green);
    }

    .btn-mork-borg.btn-info:hover {
        background: var(--mork-green);
        color: var(--mork-black);
        box-shadow: 0 0 15px var(--mork-green);
    }

    .btn-mork-borg.btn-danger {
        border-color: var(--mork-magenta);
        color: var(--mork-magenta);
    }

    .btn-mork-borg.btn-danger:hover {
        background: var(--mork-magenta);
        color: var(--mork-black);
        box-shadow: 0 0 15px var(--mork-magenta);
    }

    /* Header Styling */
    .main-header {
        background: var(--mork-black);
        border-bottom: 3px solid var(--mork-cyan);
        padding: 20px 0;
        margin-bottom: 0;
        box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);
    }

    .main-header h1 {
        color: var(--mork-cyan);
        text-shadow: 0 0 10px var(--mork-cyan);
        margin: 0;
        font-size: 2.5rem;
    }

    /* Control Panel */
    .control-panel {
        background: var(--mork-black);
        border: 2px solid var(--mork-cyan);
        padding: 15px;
        margin-bottom: 0;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    }

    /* Main Layout - Side by Side */
    .main-content {
        display: flex;
        height: calc(100vh - 200px);
        min-height: 600px;
    }

    .map-side {
        flex: 1;
        background: var(--mork-black);
        border-right: 2px solid var(--mork-cyan);
        padding: 20px;
        overflow: hidden;
        position: relative;
    }

    .modal-side {
        flex: 1;
        background: var(--mork-black);
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    /* Map Container */
    .map-container {
        background: var(--mork-black);
        border: 2px solid var(--mork-cyan);
        border-radius: 0;
        padding: 15px;
        height: 100%;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }
    
    .hex-grid {
        font-family: 'Courier New', monospace;
        font-size: 11px;
        line-height: 1.1;
        overflow: auto;
        height: calc(100% - 40px);
        background: var(--mork-black);
        padding: 15px;
        border: 1px solid var(--mork-cyan);
        text-align: center;
        white-space: nowrap;
    }
    
    .hex-cell {
        cursor: pointer;
        padding: 1px 2px;
        border-radius: 2px;
        transition: all 0.2s;
        display: inline-block;
        width: 16px;
        text-align: center;
        margin-right: 0px;
        position: relative;
    }
    
    .hex-cell:hover {
        background-color: rgba(0, 255, 255, 0.3);
        transform: scale(1.3);
        z-index: 10;
        box-shadow: 0 0 8px var(--mork-cyan);
    }

    .hex-cell.selected {
        background-color: rgba(255, 255, 0, 0.4);
        box-shadow: 0 0 10px var(--mork-yellow);
        transform: scale(1.2);
    }
    
    .major-city {
        color: var(--mork-yellow) !important;
        font-weight: bold;
        text-shadow: 0 0 5px var(--mork-yellow);
    }
    
    .settlement {
        color: var(--mork-green) !important;
        font-weight: bold;
        text-shadow: 0 0 5px var(--mork-green);
    }
    
    .terrain-mountain { color: var(--mork-magenta); }
    .terrain-forest { color: var(--mork-green); }
    .terrain-coast { color: var(--mork-cyan); }
    .terrain-plains { color: var(--mork-yellow); }
    .terrain-swamp { color: var(--mork-orange); }
    .terrain-unknown { color: var(--mork-gray); }
    
    .has-content {
        font-weight: bold;
        opacity: 1;
    }
    
    .no-content {
        opacity: 0.6;
    }
    
    /* Modal Side Content */
    .modal-content-container {
        background: var(--mork-black);
        border: 2px solid var(--mork-cyan);
        padding: 20px;
        height: 100%;
        overflow-y: auto;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
    }

    .modal-header {
        border-bottom: 2px solid var(--mork-cyan);
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    
    .modal-header h3 {
        color: var(--mork-cyan);
        margin: 0;
        font-size: 1.8rem;
    }

    .close-btn {
        background: var(--mork-black);
        border: 2px solid var(--mork-magenta);
        color: var(--mork-magenta);
        font-size: 1.5rem;
        padding: 5px 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close-btn:hover {
        background: var(--mork-magenta);
        color: var(--mork-black);
        box-shadow: 0 0 10px var(--mork-magenta);
    }

    .content-section {
        margin-bottom: 25px;
        padding: 15px;
        border: 1px solid var(--mork-cyan);
        background: rgba(0, 255, 255, 0.05);
    }

    .content-section h4 {
        color: var(--mork-yellow);
        margin-bottom: 10px;
        font-size: 1.2rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .ascii-terrain {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.2;
        color: var(--mork-green);
        margin: 10px 0;
        text-align: center;
    }

    .ascii-modal {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.3;
        color: var(--mork-cyan);
        background: var(--mork-black);
        border: 1px solid var(--mork-cyan);
        padding: 15px;
        margin: 10px 0;
        white-space: pre;
    }

    /* Legend */
    .legend-integrated {
        font-size: 0.85em;
        color: var(--mork-cyan);
        padding: 5px 0;
    }
    
    .legend-integrated strong {
        color: var(--mork-white);
        font-size: 0.9em;
    }
    
    .map-row {
        display: block;
        text-align: left;
        margin: 0 auto;
        width: fit-content;
    }
    
    .row-number {
        display: inline-block;
        width: 30px;
        text-align: right;
        margin-right: 5px;
        color: var(--mork-cyan);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .main-content {
            flex-direction: column;
            height: auto;
        }

        .map-side, .modal-side {
            flex: none;
            width: 100%;
        }

        .map-side {
            border-right: none;
            border-bottom: 2px solid var(--mork-cyan);
            height: 400px;
        }

        .modal-side {
            height: 500px;
        }

        .main-header h1 {
            font-size: 2rem;
        }
    }

    @media (max-width: 576px) {
        .control-panel .btn-group {
            margin-bottom: 10px;
        }

        .legend-integrated {
            font-size: 0.75em;
        }
    }

    /* Loading States */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: var(--mork-cyan);
        font-size: 1.2rem;
    }

    .loading::after {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid var(--mork-cyan);
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: var(--mork-gray);
        text-align: center;
    }

    .empty-state h4 {
        color: var(--mork-cyan);
        margin-bottom: 15px;
    }

    .empty-state p {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
    <div class="container-fluid">
            <h1 class="text-center">THE DYING LANDS</h1>
        </div>
        </header>
        
        <!-- Control Panel -->
        <div class="control-panel">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <div class="btn-group me-2" role="group">
                        <button class="btn btn-mork-borg btn-warning" onclick="showTerrainOverview()">üó∫Ô∏è TERRAIN</button>
                        <button class="btn btn-mork-borg btn-info" onclick="showLoreOverview()">üìú LORE</button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-mork-borg btn-danger" onclick="resetContinent()">üîÑ RESET CONTINENT</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="legend-integrated">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>TERRAIN:</strong><br>
                                <span class="terrain-mountain">^</span> MOUNTAIN &nbsp;
                                <span class="terrain-forest">‚ô†</span> FOREST &nbsp;
                                <span class="terrain-coast">~</span> COAST<br>
                                <span class="terrain-plains">.</span> PLAINS &nbsp;
                                <span class="terrain-swamp">#</span> SWAMP
                </div>
                            <div class="col-md-6">
                                <strong>LOCATIONS:</strong><br>
                                <span class="major-city">‚óÜ</span> MAJOR CITIES<br>
                                <span class="settlement">‚åÇ</span> SETTLEMENTS<br>
                                <strong>BOLD</strong> = HAS CONTENT
            </div>
        </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
        
    <!-- Main Content - Side by Side Layout -->
    <div class="main-content">
        <!-- Left Side - Map -->
        <div class="map-side">
        <div class="map-container">
                <div class="hex-grid" id="hexGrid">
                    <!-- Map content will be loaded here -->
                    {% if ascii_map %}
                        <!-- Column headers -->
                        <div class="text-center mb-2">
                            <span style="margin-right: 20px;"></span>
                            {% for x in range(1, map_width + 1) %}
                                <span style="margin-right: 4px; font-size: 9px; display: inline-block; width: 12px; text-align: center;">{{ '%02d' % x }}</span>
                            {% endfor %}
                        </div>
                        
                        <!-- Map rows -->
                        {% for y in range(1, map_height + 1) %}
                            <div class="map-row">
                                <span class="row-number">{{ '%02d' % y }}</span>
                                {% for x in range(1, map_width + 1) %}
                                    {% set hex_code = '%02d%02d' % (x, y) %}
                                    {% set hex_data = ascii_map[hex_code] %}
                                    {% if hex_data %}
                                        {% set css_class = hex_data.css_class %}
                                        {% set symbol = hex_data.symbol %}
                                        {% set has_content = 'has-content' if hex_data.has_content else 'no-content' %}
                                        {% set title = 'HEX ' + hex_code + ' - ' + hex_data.city_name if hex_data.is_city else 'HEX ' + hex_code %}
                                        <span class="hex-cell {{ css_class }} {{ has_content }}" 
                                              onclick="showHexDetails('{{ hex_code }}')" 
                                              data-hex="{{ hex_code }}"
                                              title="{{ title }}">{{ symbol }}</span>
                                    {% else %}
                                        <span class="hex-cell terrain-unknown no-content" 
                                              onclick="showHexDetails('{{ hex_code }}')" 
                                              data-hex="{{ hex_code }}"
                                              title="HEX {{ hex_code }}">?</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div style="color: red; font-size: 20px;">MAP LOADING...</div>
                    {% endif %}
                </div>
            </div>
                </div>
                
        <!-- Right Side - Modal Content -->
        <div class="modal-side">
            <div class="modal-content-container" id="modalContainer">
                <div class="empty-state">
                    <h4>SELECT A HEX</h4>
                    <p>Click on any hex on the map to view its details, encounters, and lore.</p>
                    <div class="ascii-modal">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    THE DYING LANDS                           ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                              ‚ïë
‚ïë  Click a hex to explore its mysteries...                    ‚ïë
‚ïë                                                              ‚ïë
‚ïë  Each hex contains unique encounters, denizens,             ‚ïë
‚ïë  and secrets waiting to be discovered.                      ‚ïë
‚ïë                                                              ‚ïë
‚ïë  The world is dying, but adventure lives on.                ‚ïë
‚ïë                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                </div>
                </div>
            </div>
            </div>
        </div>
        
    <!-- Hidden Modal for Mobile -->
    <div class="modal fade" id="mobileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mobileModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="mobileModalBody">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hex Details Modal -->
    <div class="modal fade" id="hexModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hexModalTitle">HEX DETAILS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="hexModalBody">
                    LOADING...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CLOSE</button>
                    <button type="button" class="btn btn-primary" onclick="generateHexContent()">GENERATE CONTENT</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- City Details Modal -->
    <div class="modal fade" id="cityModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cityModalTitle">CITY DETAILS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="cityModalBody">
                    LOADING...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CLOSE</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Terrain Overview Modal -->
    <div class="modal fade" id="terrainModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üó∫Ô∏è TERRAIN OVERVIEW</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="terrainModalBody">
                    LOADING...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lore Overview Modal -->
    <div class="modal fade" id="loreModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìú M√ñRK BORG LORE</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="loreModalBody">
                    LOADING...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    console.log('=== SCRIPT STARTING ===');
    
    let currentHex = '';
    let mapZoom = 1;
    
    // Map data from server
    let mapData = {};
    let mapWidth = 0;
    let mapHeight = 0;
    try {
        mapData = {{ ascii_map | tojson | safe }};
        mapWidth = {{ map_width|int }};
        mapHeight = {{ map_height|int }};
    } catch (error) {
        console.error('Error loading map data:', error);
        window.mapDataError = error.message;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        renderMap();
    });
    
    function renderMap() {
        const hexGrid = document.getElementById('hexGrid');
        if (!hexGrid) {
            console.error('hexGrid element not found');
            return;
        }
        if (window.mapDataError) {
            hexGrid.innerHTML = '<div style="color: red; font-size: 20px;">ERROR LOADING MAP DATA: ' + window.mapDataError + '</div>';
            return;
        }
        
        console.log('Found hexGrid element, rendering map...');
        console.log('Map data keys:', Object.keys(mapData).length);
        console.log('Map width:', mapWidth, 'Map height:', mapHeight);
        
        let html = '';
        
        // Add column headers
        html += '<div class="text-center mb-2">';
        html += '<span style="margin-right: 20px;"></span>';
        for (let x = 1; x <= mapWidth; x++) {
            const xLabel = x <= 9 ? `0${x}` : `${x}`;
            html += `<span style="margin-right: 4px; font-size: 9px; display: inline-block; width: 12px; text-align: center;">${xLabel}</span>`;
        }
        html += '</div>';
        
        // Render map rows
        for (let y = 1; y <= mapHeight; y++) {
            html += '<div class="map-row">';
            html += `<span class="row-number">${y.toString().padStart(2, '0')}</span>`;
            
            for (let x = 1; x <= mapWidth; x++) {
                const hexCode = `${x.toString().padStart(2, '0')}${y.toString().padStart(2, '0')}`;
                const hexData = mapData[hexCode];
                
                if (hexData) {
                    const cssClass = hexData.css_class;
                    const symbol = hexData.symbol;
                    const hasContent = hexData.has_content ? 'has-content' : 'no-content';
                    const title = hexData.is_city ? `HEX ${hexCode} - ${hexData.city_name}` : `HEX ${hexCode}`;
                    
                    html += `<span class="hex-cell ${cssClass} ${hasContent}" 
                                   onclick="showHexDetails('${hexCode}')" 
                                   data-hex="${hexCode}"
                                   title="${title}">${symbol}</span>`;
                } else {
                    html += `<span class="hex-cell terrain-unknown no-content" 
                                   onclick="showHexDetails('${hexCode}')" 
                                   data-hex="${hexCode}"
                                   title="HEX ${hexCode}">?</span>`;
                }
            }
            
            html += '</div>';
        }
        
        console.log('Setting innerHTML, length:', html.length);
        hexGrid.innerHTML = html;
        console.log('=== MAP RENDERED SUCCESSFULLY ===');
    }

    function showHexDetails(hexCode) {
        currentHex = hexCode;
        
        // Highlight selected hex on the map
        clearHexSelection();
        const hexElement = document.querySelector(`[data-hex="${hexCode}"]`);
        if (hexElement) {
            hexElement.classList.add('selected');
        }
        
        // Show loading state
        showLoadingState();
        
        fetch(`/api/hex/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.is_major_city) {
                    showCityDetails(hexCode);
                    return;
                }
                
                if (data.is_settlement) {
                    showSettlementDetails(hexCode);
                    return;
                }
                
                // Display content in the side panel
                displayHexContent(data, hexCode);
            })
            .catch(error => {
                console.error('Error fetching hex details:', error);
                showErrorState(hexCode);
            });
    }

    function clearHexSelection() {
        document.querySelectorAll('.hex-cell.selected').forEach(el => {
            el.classList.remove('selected');
        });
    }

    function showLoadingState() {
        const modalContainer = document.getElementById('modalContainer');
        modalContainer.innerHTML = `
            <div class="loading">
                Loading hex details...
            </div>
        `;
    }

    function showErrorState(hexCode) {
        const modalContainer = document.getElementById('modalContainer');
        modalContainer.innerHTML = `
            <div class="empty-state">
                <h4>ERROR LOADING HEX ${hexCode}</h4>
                <p>Failed to load hex details. Please try again.</p>
            </div>
        `;
    }

    function displayHexContent(data, hexCode) {
        const modalContainer = document.getElementById('modalContainer');
        
        let html = '';
        if (data.exists) {
            html = generateHexModalHTML(data, hexCode);
        } else {
            html = generateEmptyHexHTML(hexCode);
        }
        
        modalContainer.innerHTML = html;
    }

    function generateHexModalHTML(data, hexCode) {
        const terrain = data.terrain || 'unknown';
        const encounter = data.encounter || 'Unknown encounter';
        const denizen = data.denizen || 'No denizen information';
        const notableFeature = data.notable_feature || 'No notable features';
        const atmosphere = data.atmosphere || 'Unknown atmosphere';
        
        // Generate ASCII terrain art
        const asciiTerrain = getAsciiTerrain(terrain);
        
        // Generate ASCII modal frame
        const asciiModal = generateAsciiModal(data, hexCode);
        
        return `
            <div class="modal-header">
                <h3>HEX ${hexCode} - ${terrain.toUpperCase()}</h3>
                <button class="close-btn" onclick="clearHexSelection()">√ó</button>
            </div>
            
            <div class="content-section">
                <h4>TERRAIN</h4>
                <p>${terrain.charAt(0).toUpperCase() + terrain.slice(1)}</p>
                <div class="ascii-terrain">
${asciiTerrain}
                </div>
            </div>
            
            <div class="content-section">
                <h4>ENCOUNTER</h4>
                <p>${encounter}</p>
            </div>
            
            <div class="content-section">
                <h4>DENIZEN</h4>
                <p>${denizen}</p>
            </div>
            
            <div class="content-section">
                <h4>NOTABLE FEATURES</h4>
                <p>${notableFeature}</p>
            </div>
            
            <div class="content-section">
                <h4>ATMOSPHERE</h4>
                <p>${atmosphere}</p>
            </div>
            
            <div class="ascii-modal">
${asciiModal}
            </div>
        `;
    }

    function generateEmptyHexHTML(hexCode) {
        return `
            <div class="modal-header">
                <h3>HEX ${hexCode}</h3>
                <button class="close-btn" onclick="clearHexSelection()">√ó</button>
            </div>
            
            <div class="empty-state">
                <h4>NO CONTENT GENERATED</h4>
                <p>This hex has no content yet. Click "Generate Content" to create encounters and details.</p>
                <button class="btn btn-mork-borg" onclick="generateHexContent('${hexCode}')">GENERATE CONTENT</button>
            </div>
        `;
    }

    function getAsciiTerrain(terrain) {
        const terrainArt = {
            'mountain': `    /\\   /\\   /\\
   /  \\_/  \\_/  \\
  /            \\
 /              \\`,
            'forest': `      /\\      /\\
     /  \\    /  \\
    /____\\  /____\\
      ||      ||`,
            'coast': `   ~   ~   ~   ~
 ~   ~   ~   ~
   ~   ~   ~   ~`,
            'plains': `  .  .  .  .  .
 .  .  .  .  .
  .  .  .  .  .`,
            'swamp': `  # # # # # #
 # # # # # # #
  # # # # # #`,
            'desert': `  ~~~~~~~~~~~
 ~~~~~.~~~~~
  ~~~~~~~~~~~`
        };
        
        return terrainArt[terrain] || terrainArt['plains'];
    }

    function generateAsciiModal(data, hexCode) {
        const terrain = data.terrain || 'unknown';
        const encounter = data.encounter || 'Unknown encounter';
        const denizen = data.denizen || 'No denizen information';
        const notableFeature = data.notable_feature || 'No notable features';
        const atmosphere = data.atmosphere || 'Unknown atmosphere';
        
                 return `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    HEX ${hexCode} - ${terrain.toUpperCase()}                    ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                              ‚ïë
‚ïë  TERRAIN: ${terrain.padEnd(50)} ‚ïë
‚ïë  ${getAsciiTerrain(terrain).split('\\n').map(line => `  ${line.padEnd(50)} ‚ïë`).join('\\n')}
‚ïë                                                              ‚ïë
‚ïë  ENCOUNTER: ${encounter.substring(0, 50).padEnd(50)} ‚ïë
‚ïë                                                              ‚ïë
‚ïë  DENIZEN: ${denizen.substring(0, 50).padEnd(50)} ‚ïë
‚ïë                                                              ‚ïë
‚ïë  FEATURES: ${notableFeature.substring(0, 50).padEnd(50)} ‚ïë
‚ïë                                                              ‚ïë
‚ïë  ATMOSPHERE: ${atmosphere.substring(0, 50).padEnd(50)} ‚ïë
‚ïë                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`;
     }
    }
    
    function showCityDetails(hexCode) {
        fetch(`/api/city/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const city = data.city;
                    document.getElementById('cityModalTitle').textContent = city.name;
                    
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üó∫Ô∏è CITY MAP</h6>
                                <pre>${data.city_map}</pre>
                            </div>
                            <div class="col-md-6">
                                <h6>üè∞ CITY INFORMATION</h6>
                                <p><strong>LOCATION:</strong> HEX ${hexCode} (${city.region.charAt(0).toUpperCase() + city.region.slice(1)})</p>
                                <p><strong>POPULATION:</strong> ${city.population}</p>
                                <p><strong>DESCRIPTION:</strong> ${city.description}</p>
                                <p><strong>ATMOSPHERE:</strong> ${city.atmosphere}</p>
                                
                                <h6 class="mt-3">NOTABLE FEATURES</h6>
                                <ul style="font-size:0.9em;">
                    `;
                    
                    city.notable_features.forEach(feature => {
                        html += `<li>${feature}</li>`;
                    });
                    
                    html += `
                                </ul>
                                
                                <h6 class="mt-3">KEY NPCS</h6>
                                <div class="d-flex flex-wrap gap-2">
                    `;
                    
                    city.key_npcs.forEach(npc => {
                        html += `<span class="badge bg-info">${npc}</span>`;
                    });
                    
                    html += `
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>üè∞ REGIONAL NPCS</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                    `;
                    
                    data.regional_npcs.forEach(npc => {
                        html += `<span class="badge bg-secondary">${npc}</span>`;
                    });
                    
                    html += `
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>‚öîÔ∏è ACTIVE FACTIONS</h6>
                    `;
                    
                    data.factions.forEach(faction => {
                        const influenceColors = {
                            'religious': 'warning',
                            'apocalyptic': 'danger',
                            'political': 'primary',
                            'biological': 'success',
                            'magical': 'info'
                        };
                        const badgeColor = influenceColors[faction.influence] || 'secondary';
                        
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <h6 class="mb-1" style="font-size:0.9em;">${faction.name} <span class="badge bg-${badgeColor}">${faction.influence}</span></h6>
                                    <small class="text-muted">${faction.description}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('cityModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('cityModal')).show();
                } else {
                    alert('ERROR LOADING CITY DETAILS: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR LOADING CITY:', error);
                alert('ERROR LOADING CITY DETAILS');
            });
    }
    
    function showSettlementDetails(hexCode) {
        fetch(`/api/settlement/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const settlement = data.settlement;
                    document.getElementById('cityModalTitle').textContent = settlement.name;
                    
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üó∫Ô∏è SETTLEMENT MAP</h6>
                                <pre>${data.settlement_map}</pre>
                            </div>
                            <div class="col-md-6">
                                <h6>‚åÇ SETTLEMENT INFORMATION</h6>
                                <p><strong>LOCATION:</strong> HEX ${hexCode} (${data.terrain.charAt(0).toUpperCase() + data.terrain.slice(1)})</p>
                                <p><strong>POPULATION:</strong> ${settlement.population}</p>
                                <p><strong>DESCRIPTION:</strong> ${settlement.description}</p>
                                <p><strong>ATMOSPHERE:</strong> ${settlement.atmosphere}</p>
                                
                                <h6 class="mt-3">NOTABLE FEATURE</h6>
                                <p style="font-size:0.9em;">${settlement.notable_feature}</p>
                                
                                <h6 class="mt-3">LOCAL TAVERN</h6>
                                <p style="font-size:0.9em;">${settlement.local_tavern}</p>
                                
                                <h6 class="mt-3">LOCAL POWER</h6>
                                <p style="font-size:0.9em;">${settlement.local_power}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>üèóÔ∏è SETTLEMENT LAYOUT</h6>
                                <pre style="font-size:0.8em; background: #000; border: 1px solid #00ffff; padding: 10px;">${settlement.settlement_art}</pre>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('cityModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('cityModal')).show();
                } else {
                    alert('ERROR LOADING SETTLEMENT DETAILS: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR LOADING SETTLEMENT:', error);
                alert('ERROR LOADING SETTLEMENT DETAILS');
            });
    }
    
    function generateHexContent() {
        if (!currentHex) return;
        
        fetch('/api/generate-hex', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hex: currentHex })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showHexDetails(currentHex);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                alert('FAILED TO GENERATE CONTENT: ' + data.error);
            }
        })
        .catch(error => {
            console.error('ERROR GENERATING HEX:', error);
            alert('ERROR GENERATING HEX CONTENT');
        });
    }
    
    function generateFullMap() {
        if (confirm('GENERATE CONTENT FOR THE ENTIRE MAP? THIS MAY TAKE A WHILE...')) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ GENERATING...';
            btn.disabled = true;
            
            fetch('/api/generate-full-map', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`GENERATED ${data.count} HEXES!`);
                    window.location.reload();
                } else {
                    alert('FAILED TO GENERATE MAP: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR GENERATING MAP:', error);
                alert('ERROR GENERATING FULL MAP');
            })
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }
    }
    
    function resetContinent() {
        if (confirm('üö® RESET ENTIRE CONTINENT? üö®\n\nTHIS WILL DELETE ALL GENERATED CONTENT AND CREATE A COMPLETELY FRESH MAP.\n\nTHIS ACTION CANNOT BE UNDONE!')) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'üîÑ RESETTING...';
            btn.disabled = true;
            
            // Disable all other buttons during reset
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(button => button.disabled = true);
            
            fetch('/api/reset-continent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå FAILED TO RESET CONTINENT: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR RESETTING CONTINENT:', error);
                alert('‚ùå ERROR RESETTING CONTINENT');
            })
            .finally(() => {
                // Re-enable all buttons
                allButtons.forEach(button => button.disabled = false);
                btn.textContent = originalText;
            });
        }
    }
    
    function showTerrainOverview() {
        fetch('/api/terrain-overview')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const [width, height] = data.dimensions;
                    let html = `
                        <div class="row">
                            <div class="col-md-8">
                                <pre>${data.terrain_map}</pre>
                            </div>
                            <div class="col-md-4">
                                <h6>üìä TERRAIN STATISTICS</h6>
                    `;
                    
                    for (const key in data.distribution) {
                        if (!data.distribution.hasOwnProperty(key)) continue;
                        const terrain = String(key);
                        const count = data.distribution[key];
                        const percentage = ((count / (width * height)) * 100).toFixed(1);
                        html += `<div class="mb-2">
                            <span class="terrain-${terrain}">${getTerrainSymbol(terrain)}</span>
                            <strong>${terrain.charAt(0).toUpperCase() + terrain.slice(1)}</strong>: 
                            ${count} HEXES (${percentage}%)
                        </div>`;
                    }
                    
                    html += `
                                <hr>
                                <h6>üó∫Ô∏è MAP INFO</h6>
                                <div class="small">
                                    <strong>DIMENSIONS:</strong> ${width}√ó${height}<br>
                                    <strong>TOTAL HEXES:</strong> ${width * height}<br>
                                    <strong>LORE INTEGRATION:</strong> ‚úÖ ACTIVE
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('terrainModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('terrainModal')).show();
                } else {
                    alert('ERROR LOADING TERRAIN OVERVIEW: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR LOADING TERRAIN OVERVIEW:', error);
                alert('ERROR LOADING TERRAIN OVERVIEW');
            });
    }
    
    function showLoreOverview() {
        fetch('/api/lore-overview')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üè∞ MAJOR CITIES (${data.major_cities})</h6>
                    `;
                    
                    data.cities_data.forEach(city => {
                        html += `
                            <div class="card mb-2" onclick="showCityDetails('${city.hex_code}')" style="cursor:pointer;">
                                <div class="card-body py-2">
                                    <h6 class="mb-1">${city.name} <span class="badge bg-secondary">${city.hex_code}</span></h6>
                                    <small class="text-muted">${city.region} - ${city.population}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                            <div class="col-md-6">
                                <h6>‚öîÔ∏è MAJOR FACTIONS (${data.factions})</h6>
                    `;
                    
                    data.factions_data.forEach(faction => {
                        const influenceColors = {
                            'religious': 'warning',
                            'apocalyptic': 'danger',
                            'political': 'primary',
                            'biological': 'success',
                            'magical': 'info'
                        };
                        const badgeColor = influenceColors[faction.influence] || 'secondary';
                        
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <h6 class="mb-1">${faction.name} <span class="badge bg-${badgeColor}">${faction.influence}</span></h6>
                                    <small class="text-muted">ACTIVE IN: ${faction.regions.join(', ')}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="alert alert-info">
                                <strong>üé≤ GAME MASTER NOTE:</strong> THIS LORE IS INTEGRATED INTO HEX GENERATION. 
                                CITIES AND FACTIONS INFLUENCE CONTENT IN THEIR REGIONS.
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('loreModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('loreModal')).show();
                } else {
                    alert('ERROR LOADING LORE OVERVIEW: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR LOADING LORE OVERVIEW:', error);
                alert('ERROR LOADING LORE OVERVIEW');
            });
    }
    
    function getTerrainSymbol(terrain) {
        const symbols = {
            'mountain': '^', 'forest': '‚ô†', 'coast': '~',
            'plains': '.', 'swamp': '#', 'unknown': '?'
        };
        return symbols[terrain] || '?';
    }
    
    function zoomIn() {
        mapZoom = Math.min(mapZoom * 1.2, 3);
        applyZoom();
    }
    
    function zoomOut() {
        mapZoom = Math.max(mapZoom / 1.2, 0.5);
        applyZoom();
    }
    
    function applyZoom() {
        const mapElement = document.getElementById('hexGrid'); // Changed from map-grid to hexGrid
        if (mapElement) {
            mapElement.style.transform = `scale(${mapZoom})`;
            mapElement.style.transformOrigin = 'top left';
        }
    }
    
    function showLegend() {
        document.getElementById('legend').scrollIntoView({ behavior: 'smooth' });
    }
    </script>
</body>
</html>