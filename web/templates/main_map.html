<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ºï¸ The Dying Lands - Interactive Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/fonts.css" rel="stylesheet">
    <style>
    :root {
        --mork-black: #000000;
        --mork-cyan: #00FFFF;
        --mork-yellow: #FFFF00;
        --mork-green: #00FF00;
        --mork-magenta: #FF00FF;
        --mork-white: #FFFFFF;
        --mork-orange: #FF8000;
        --mork-gray: #808080;
    }

    body {
        background: var(--mork-black);
        color: var(--mork-white);
        font-family: 'pixelify-sans', monospace;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }
    
    h1, h2, h3, h4, h5, h6 {
        font-family: 'adhesive-nr-seven', serif;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    /* MÃ¶rk Borg Button Styling */
    .btn-mork-borg {
        background: var(--mork-black);
        border: 2px solid var(--mork-cyan);
        color: var(--mork-cyan);
        font-family: 'adhesive-nr-seven', serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: bold;
        padding: 8px 16px;
        margin: 2px;
        transition: all 0.3s ease;
        border-radius: 0;
        position: relative;
        overflow: hidden;
    }

    .btn-mork-borg:hover {
        background: var(--mork-cyan);
        color: var(--mork-black);
        box-shadow: 0 0 15px var(--mork-cyan);
        transform: translateY(-2px);
    }

    .btn-mork-borg:active {
        transform: translateY(0);
        box-shadow: 0 0 8px var(--mork-cyan);
    }

    .btn-mork-borg.btn-warning {
        border-color: var(--mork-yellow);
        color: var(--mork-yellow);
    }

    .btn-mork-borg.btn-warning:hover {
        background: var(--mork-yellow);
        color: var(--mork-black);
        box-shadow: 0 0 15px var(--mork-yellow);
    }

    .btn-mork-borg.btn-info {
        border-color: var(--mork-green);
        color: var(--mork-green);
    }

    .btn-mork-borg.btn-info:hover {
        background: var(--mork-green);
        color: var(--mork-black);
        box-shadow: 0 0 15px var(--mork-green);
    }

    .btn-mork-borg.btn-danger {
        border-color: var(--mork-magenta);
        color: var(--mork-magenta);
    }

    .btn-mork-borg.btn-danger:hover {
        background: var(--mork-magenta);
        color: var(--mork-black);
        box-shadow: 0 0 15px var(--mork-magenta);
    }

    /* Header Styling */
    .main-header {
        background: var(--mork-black);
        border-bottom: 3px solid var(--mork-cyan);
        padding: 20px 0;
        margin-bottom: 0;
        box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);
    }

    .main-header h1 {
        color: var(--mork-cyan);
        text-shadow: 0 0 10px var(--mork-cyan);
        margin: 0;
        font-size: 2.5rem;
    }

    .header-ascii {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.2;
        color: var(--mork-cyan);
        margin: 0;
        text-shadow: 0 0 10px var(--mork-cyan);
    }

    .dice-yellow {
        color: var(--mork-yellow);
        text-shadow: 0 0 10px var(--mork-yellow);
    }

    .dice-red {
        color: var(--mork-magenta);
        text-shadow: 0 0 10px var(--mork-magenta);
    }

    @media (max-width: 768px) {
        .header-ascii {
            font-size: 8px;
        }
        
        .main-header h1 {
            font-size: 2rem;
        }
    }

    @media (max-width: 576px) {
        .header-ascii {
            font-size: 6px;
        }
        
        .main-header h1 {
            font-size: 1.5rem;
        }
    }

    /* Control Panel */
    .control-panel {
        background: var(--mork-black);
        border: 2px solid var(--mork-cyan);
        padding: 15px;
        margin-bottom: 0;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    }

    /* Main Layout - Side by Side */
    .main-content {
        display: flex;
        height: calc(100vh - 200px);
        min-height: 600px;
    }

    .map-side {
        flex: 1;
        background: var(--mork-black);
        border-right: 2px solid var(--mork-cyan);
        padding: 20px;
        overflow: hidden;
        position: relative;
    }

    .modal-side {
        flex: 1;
        background: var(--mork-black);
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    /* Map Container */
    .map-container {
        background: var(--mork-black);
        border: 2px solid var(--mork-cyan);
        border-radius: 0;
        padding: 15px;
        height: 100%;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }
    
    .hex-grid {
        font-family: 'Courier New', monospace;
        font-size: 11px;
        line-height: 1.1;
        overflow: auto;
        height: calc(100% - 40px);
        background: var(--mork-black);
        padding: 15px;
        border: 1px solid var(--mork-cyan);
        text-align: center;
        white-space: nowrap;
    }
    
    .hex-cell {
        cursor: pointer;
        padding: 1px 2px;
        border-radius: 2px;
        transition: all 0.2s;
        display: inline-block;
        width: 16px;
        text-align: center;
        margin-right: 0px;
        position: relative;
    }
    
    .hex-cell:hover {
        background-color: rgba(0, 255, 255, 0.3);
        transform: scale(1.3);
        z-index: 10;
        box-shadow: 0 0 8px var(--mork-cyan);
    }

    .hex-cell.selected {
        background-color: rgba(255, 255, 0, 0.4);
        box-shadow: 0 0 10px var(--mork-yellow);
        transform: scale(1.2);
        animation: blink 1s ease-in-out infinite;
    }
    
    @keyframes blink {
        0%, 50% {
            opacity: 1;
        }
        25%, 75% {
            opacity: 0.3;
        }
    }
    
    .major-city {
        color: var(--mork-yellow) !important;
        font-weight: bold;
        text-shadow: 0 0 5px var(--mork-yellow);
    }
    
    .settlement {
        color: var(--mork-green) !important;
        font-weight: bold;
        text-shadow: 0 0 5px var(--mork-green);
    }
    
    .terrain-mountain { color: var(--mork-magenta); }
    .terrain-forest { color: var(--mork-green); }
    .terrain-coast { color: var(--mork-cyan); }
    .terrain-plains { color: var(--mork-yellow); }
    .terrain-swamp { color: var(--mork-orange); }
    .terrain-sea { color: var(--mork-cyan); }
    .terrain-unknown { color: var(--mork-gray); }
    
    .has-content {
        font-weight: bold;
        opacity: 1;
    }
    
    .no-content {
        opacity: 0.6;
    }
    
    /* Modal Side Content */
    .modal-content-container {
        background: var(--mork-black);
        border: 2px solid var(--mork-cyan);
        padding: 20px;
        height: 100%;
        overflow-y: auto;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
    }

    .ascii-modal {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.3;
        color: var(--mork-cyan);
        background: var(--mork-black);
        border: 1px solid var(--mork-cyan);
        padding: 15px;
        margin: 10px 0;
        white-space: pre;
    }

    /* Legend */
    .legend-integrated {
        font-size: 0.85em;
        color: var(--mork-cyan);
        padding: 5px 0;
    }
    
    .legend-integrated strong {
        color: var(--mork-white);
        font-size: 0.9em;
    }
    
    .map-row {
        display: block;
        text-align: left;
        margin: 0 auto;
        width: fit-content;
    }
    
    .row-number {
        display: inline-block;
        width: 30px;
        text-align: right;
        margin-right: 5px;
        color: var(--mork-cyan);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .main-content {
            flex-direction: column;
            height: auto;
        }

        .map-side, .modal-side {
            flex: none;
            width: 100%;
        }

        .map-side {
            border-right: none;
            border-bottom: 2px solid var(--mork-cyan);
            height: 400px;
        }

        .modal-side {
            height: 500px;
        }

        .main-header h1 {
            font-size: 2rem;
        }
    }

    @media (max-width: 576px) {
        .control-panel .btn-group {
            margin-bottom: 10px;
        }

        .legend-integrated {
            font-size: 0.75em;
        }
    }

    /* Loading States */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: var(--mork-cyan);
        font-size: 1.2rem;
    }

    .loading::after {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid var(--mork-cyan);
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: var(--mork-gray);
        text-align: center;
    }

    .empty-state h4 {
        color: var(--mork-cyan);
        margin-bottom: 15px;
    }

    .empty-state p {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="container-fluid">
            <div class="text-center">
                <pre class="header-ascii" id="headerAscii">

 ****            *********************************            ****
   *******      ***           *******           ***      *******
      ************   <span id="dice1">6</span>         *****   <span id="dice2">6</span>         ************
         **********    **** * **   ** *******   **********
               ********** ** **     ** ****************
         *************** ** **  ***  **  *****************
          ******   *********************  ******   ******
                </pre>
                <h1 style="margin-top: 10px;">THE DYING LANDS</h1>
            </div>
        </div>
    </header>
        
        <!-- Control Panel -->
        <div class="control-panel">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4">
                    <div class="btn-group me-2" role="group">
                        <button class="btn btn-mork-borg" onclick="showLoreOverview()">ğŸ“œ LORE</button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-mork-borg" onclick="resetContinent()">ğŸ”„ RESET CONTINENT</button>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="language-select" style="color: var(--mork-cyan); font-size: 0.9em; margin-bottom: 5px;">LANGUAGE:</label>
                        <select id="language-select" class="form-control" style="background: var(--mork-black); border: 1px solid var(--mork-cyan); color: var(--mork-cyan); font-family: 'pixelify-sans', monospace; font-size: 0.9em;" onchange="changeLanguage(this.value)">
                            <option value="en">ENGLISH</option>
                            <option value="pt">PORTUGUÃŠS</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="legend-integrated">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>TERRAIN:</strong><br>
                                                    <span class="terrain-mountain">^</span> MOUNTAIN &nbsp;
                    <span class="terrain-forest">â™ </span> FOREST &nbsp;
                    <span class="terrain-coast">~</span> COAST<br>
                    <span class="terrain-plains">.</span> PLAINS &nbsp;
                    <span class="terrain-swamp">#</span> SWAMP &nbsp;
                    <span class="terrain-sea">â‰ˆ</span> SEA
                </div>
                            <div class="col-md-6">
                                <strong>LOCATIONS:</strong><br>
                                <span class="major-city">â—†</span> MAJOR CITIES<br>
                                <span class="settlement">âŒ‚</span> SETTLEMENTS<br>
                                <strong>BOLD</strong> = HAS CONTENT
            </div>
        </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
        
    <!-- Main Content - Side by Side Layout -->
    <div class="main-content">
        <!-- Left Side - Map -->
        <div class="map-side">
        <div class="map-container">
                <div class="hex-grid" id="hexGrid">
                    <!-- Map content will be loaded here -->
                    {% if ascii_map %}
                        <!-- Column headers -->
                        <div class="text-center mb-2">
                            <span style="margin-right: 20px;"></span>
                            {% for x in range(1, map_width + 1) %}
                                <span style="margin-right: 4px; font-size: 9px; display: inline-block; width: 12px; text-align: center;">{{ '%02d' % x }}</span>
                            {% endfor %}
                        </div>
                        
                        <!-- Map rows -->
                        {% for y in range(1, map_height + 1) %}
                            <div class="map-row">
                                <span class="row-number">{{ '%02d' % y }}</span>
                                {% for x in range(1, map_width + 1) %}
                                    {% set hex_code = '%02d%02d' % (x, y) %}
                                    {% set hex_data = ascii_map[hex_code] %}
                                    {% if hex_data %}
                                        {% set css_class = hex_data.css_class %}
                                        {% set symbol = hex_data.symbol %}
                                        {% set has_content = 'has-content' if hex_data.has_content else 'no-content' %}
                                        {% set title = 'HEX ' + hex_code + ' - ' + hex_data.city_name if hex_data.is_city else 'HEX ' + hex_code %}
                                        <span class="hex-cell {{ css_class }} {{ has_content }}" 
                                              onclick="showHexDetails('{{ hex_code }}')" 
                                              data-hex="{{ hex_code }}"
                                              title="{{ title }}">{{ symbol }}</span>
                                    {% else %}
                                        <span class="hex-cell terrain-unknown no-content" 
                                              onclick="showHexDetails('{{ hex_code }}')" 
                                              data-hex="{{ hex_code }}"
                                              title="HEX {{ hex_code }}">?</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div style="color: red; font-size: 20px;">MAP LOADING...</div>
                    {% endif %}
                </div>
            </div>
                </div>
                
        <!-- Right Side - Modal Content -->
        <div class="modal-side">
            <div class="modal-content-container" id="modalContainer">
                <div class="empty-state">
                    <h4>SELECT A HEX</h4>
                    <p>Click on any hex on the map to view its details, encounters, and lore.</p>
                    <div class="ascii-modal">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    THE DYING LANDS                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                              â•‘
â•‘  Click a hex to explore its mysteries...                    â•‘
â•‘                                                              â•‘
â•‘  Each hex contains unique encounters, denizens,             â•‘
â•‘  and secrets waiting to be discovered.                      â•‘
â•‘                                                              â•‘
â•‘  The world is dying, but adventure lives on.                â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                </div>
                </div>
            </div>
            </div>
        </div>
        

    


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Map data stored in data attributes to avoid linter issues -->
    <div id="mapData" 
         data-map="{{ ascii_map | tojson | safe if ascii_map else '{}' }}"
         data-width="{{ map_width|int if map_width else 0 }}"
         data-height="{{ map_height|int if map_height else 0 }}"
         style="display: none;">
    </div>

    <script>
        let currentHex = '';
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let scrollStartX = 0;
        let scrollStartY = 0;
    
    // Map data from server - read from data attributes
    let mapData = {};
    let mapWidth = 0;
    let mapHeight = 0;
    
    // Load map data from data attributes
    document.addEventListener('DOMContentLoaded', function() {
        const mapDataElement = document.getElementById('mapData');
        if (mapDataElement) {
            try {
                mapData = JSON.parse(mapDataElement.dataset.map || '{}');
                mapWidth = parseInt(mapDataElement.dataset.width || '0');
                mapHeight = parseInt(mapDataElement.dataset.height || '0');
            } catch (error) {
                console.error('Error loading map data:', error);
            }
        }
        
        // Setup middle-click drag functionality
        setupMapDrag();
        
        // Generate random dice numbers
        generateDiceNumbers();
    });

    function generateDiceNumbers() {
        const dice1 = Math.floor(Math.random() * 6) + 1;
        const dice2 = Math.floor(Math.random() * 6) + 1;
        
        const dice1Element = document.getElementById('dice1');
        const dice2Element = document.getElementById('dice2');
        
        if (dice1Element && dice2Element) {
            dice1Element.textContent = dice1;
            dice2Element.textContent = dice2;
            
            // Remove existing color classes
            dice1Element.classList.remove('dice-yellow', 'dice-red');
            dice2Element.classList.remove('dice-yellow', 'dice-red');
            
            // Apply color based on dice values
            if (dice1 === 6 && dice2 === 6) {
                // Both sixes = red
                dice1Element.classList.add('dice-red');
                dice2Element.classList.add('dice-red');
            } else {
                // Otherwise = yellow
                dice1Element.classList.add('dice-yellow');
                dice2Element.classList.add('dice-yellow');
            }
        }
    }
    
    function setupMapDrag() {
        const hexGrid = document.getElementById('hexGrid');
        if (!hexGrid) return;
        
        // Middle mouse button drag
        hexGrid.addEventListener('mousedown', function(e) {
            if (e.button === 1) { // Middle mouse button
                e.preventDefault();
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                scrollStartX = hexGrid.scrollLeft;
                scrollStartY = hexGrid.scrollTop;
                hexGrid.style.cursor = 'grabbing';
            }
        });
        
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                hexGrid.scrollLeft = scrollStartX - deltaX;
                hexGrid.scrollTop = scrollStartY - deltaY;
            }
        });
        
        document.addEventListener('mouseup', function(e) {
            if (isDragging) {
                isDragging = false;
                hexGrid.style.cursor = 'default';
            }
        });
        
        // Prevent context menu on middle click
        hexGrid.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
    }
    
    // Language change function
    function changeLanguage(language) {
        fetch('/api/set-language', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ language: language })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`Language changed to ${language}`);
                // If a hex is currently selected, refresh its content
                if (currentHex) {
                    showHexDetails(currentHex);
                }
            } else {
                console.error('Failed to change language:', data.error);
                // Reset the select to the previous value
                document.getElementById('language-select').value = language === 'en' ? 'pt' : 'en';
            }
        })
        .catch(error => {
            console.error('Error changing language:', error);
            // Reset the select to the previous value
            document.getElementById('language-select').value = language === 'en' ? 'pt' : 'en';
        });
    }

    // Define showHexDetails function first
    function showHexDetails(hexCode) {
        currentHex = hexCode;
        
        // Highlight selected hex on the map
        clearHexSelection();
        const hexElement = document.querySelector(`[data-hex="${hexCode}"]`);
        if (hexElement) {
            hexElement.classList.add('selected');
        }
        
        fetch(`/api/hex/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.is_major_city) {
                    // Cities show in left panel (map area) with ASCII style
                    showCityDetailsInMap(hexCode);
                    return;
                }
                
                if (data.is_settlement) {
                    // Settlements show in left panel (map area) with ASCII style
                    showSettlementDetailsInMap(hexCode);
                    return;
                }
                
                // Regular hexes (encounters, dungeons, etc.) show in right panel
                displayHexContent(data, hexCode);
            })
            .catch(error => {
                console.error('Error fetching hex details:', error);
                // Show error in appropriate panel based on hex type
                if (currentHex && (currentHex.includes('city') || currentHex.includes('settlement'))) {
                    showMapErrorState(hexCode);
                } else {
                showErrorState(hexCode);
                }
            });
    }
    




    function clearHexSelection() {
        document.querySelectorAll('.hex-cell.selected').forEach(el => {
            el.classList.remove('selected');
        });
    }

    function showMapLoadingState() {
        const mapContainer = document.querySelector('.map-container');
        const originalContent = mapContainer.innerHTML;
        mapContainer.setAttribute('data-original-content', originalContent);
        
        mapContainer.innerHTML = `
            <div style="text-align: center; padding: 50px; color: var(--mork-cyan);">
                <pre style="font-family: 'pixelify-sans', monospace; font-size: 14px;">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    LOADING HEX DETAILS...                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                              â•‘
â•‘  Fetching encounters, denizens, and secrets...              â•‘
â•‘                                                              â•‘
â•‘  The dying lands reveal their mysteries slowly...           â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                </pre>
            </div>
        `;
    }

    function showMapErrorState(hexCode) {
        const mapContainer = document.querySelector('.map-container');
        mapContainer.innerHTML = `
            <div style="text-align: center; padding: 50px; color: var(--mork-magenta);">
                <pre style="font-family: 'pixelify-sans', monospace; font-size: 14px;">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ERROR LOADING HEX ${hexCode}                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                              â•‘
â•‘  Failed to load hex details.                                â•‘
â•‘  The darkness has consumed this knowledge...                â•‘
â•‘                                                              â•‘
â•‘  Please try again.                                          â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                </pre>
                <button class="btn btn-mork-borg btn-danger mt-3" onclick="restoreMap()">RETURN TO MAP</button>
            </div>
        `;
    }

    function showLoadingState() {
        const modalContainer = document.getElementById('modalContainer');
        modalContainer.innerHTML = `
            <div class="loading">
                Loading hex details...
            </div>
        `;
    }

    function showErrorState(hexCode) {
        const modalContainer = document.getElementById('modalContainer');
        modalContainer.innerHTML = `
            <div class="empty-state">
                <h4>ERROR LOADING HEX ${hexCode}</h4>
                <p>Failed to load hex details. Please try again.</p>
            </div>
        `;
    }

    function displayHexContent(data, hexCode) {
        const modalContainer = document.getElementById('modalContainer');
        
        let html = '';
        if (data.exists) {
            html = generateHexModalHTML(data, hexCode);
        } else {
            html = generateEmptyHexHTML(hexCode);
        }
        
        modalContainer.innerHTML = html;
    }

    function showCityDetailsInMap(hexCode) {
        // Show loading state in map area
        showMapLoadingState();
        
        fetch(`/api/city/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const city = data.city;
                    const mapContainer = document.querySelector('.map-container');
                    
                    let html = `
                        <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                            <div class="mb-4">
                                <button class="btn btn-mork-borg btn-warning me-2" onclick="restoreMap()">RETURN TO MAP</button>
                                <button class="btn btn-mork-borg" onclick="showCityOverlayInMap('${hexCode}')">ğŸ° CITY OVERLAYS</button>
                            </div>
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <pre style="font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.2; color: var(--mork-cyan); margin: 0; white-space: pre-wrap; word-wrap: break-word;">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ${city.name.toUpperCase().padEnd(50)}â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ LOCATION: HEX ${hexCode} - ${city.region.toUpperCase().padEnd(40)}â•‘
â•‘ POPULATION: ${city.population.padEnd(50)}â•‘
â•‘ ATMOSPHERE: ${city.atmosphere.substring(0, 50).padEnd(50)}â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ DESCRIPTION:                                                â•‘`;
                    
                    // Split description into lines
                    const descLines = city.description.match(/.{1,58}/g) || [city.description];
                    descLines.forEach(line => {
                        html += `
â•‘ ${line.padEnd(58)}â•‘`;
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ NOTABLE FEATURES:                                           â•‘`;
                    
                    city.notable_features.forEach(feature => {
                        const featureLines = feature.match(/.{1,56}/g) || [feature];
                        featureLines.forEach(line => {
                            html += `
â•‘ â€¢ ${line.padEnd(56)}â•‘`;
                        });
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ KEY NPCS:                                                   â•‘`;
                    
                    city.key_npcs.forEach(npc => {
                        const npcLines = npc.match(/.{1,56}/g) || [npc];
                        npcLines.forEach(line => {
                            html += `
â•‘ â€¢ ${line.padEnd(56)}â•‘`;
                        });
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ REGIONAL NPCS:                                              â•‘`;
                    
                    data.regional_npcs.forEach(npc => {
                        const npcLines = npc.match(/.{1,56}/g) || [npc];
                        npcLines.forEach(line => {
                            html += `
â•‘ â€¢ ${line.padEnd(56)}â•‘`;
                        });
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ACTIVE FACTIONS:                                            â•‘`;
                    
                    data.factions.forEach(faction => {
                        const factionText = `${faction.name} (${faction.influence}) - ${faction.description}`;
                        const factionLines = factionText.match(/.{1,56}/g) || [factionText];
                        factionLines.forEach(line => {
                            html += `
â•‘ â€¢ ${line.padEnd(56)}â•‘`;
                        });
                    });
                    
                    html += `
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                </pre>
                            </div>
            </div>
        `;
                    
                    mapContainer.innerHTML = html;
                } else {
                    showMapErrorState(hexCode);
                }
            })
            .catch(error => {
                console.error('ERROR LOADING CITY:', error);
                showMapErrorState(hexCode);
            });
    }

    function showSettlementDetailsInMap(hexCode) {
        // Show loading state in map area
        showMapLoadingState();
        
        fetch(`/api/settlement/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const settlement = data.settlement;
                    const mapContainer = document.querySelector('.map-container');
                    
                    let html = `
                        <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                            <button class="btn btn-mork-borg btn-warning mb-4" onclick="restoreMap()">RETURN TO MAP</button>
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <pre style="font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.2; color: var(--mork-cyan); margin: 0; white-space: pre-wrap; word-wrap: break-word;">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ${settlement.name.toUpperCase().padEnd(50)}â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ LOCATION: HEX ${hexCode} - ${data.terrain.toUpperCase().padEnd(40)}â•‘
â•‘ POPULATION: ${settlement.population.padEnd(50)}â•‘
â•‘ ATMOSPHERE: ${settlement.atmosphere.substring(0, 50).padEnd(50)}â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ DESCRIPTION:                                                â•‘`;
                    
                    // Split description into lines
                    const descLines = settlement.description.match(/.{1,58}/g) || [settlement.description];
                    descLines.forEach(line => {
                        html += `
â•‘ ${line.padEnd(58)}â•‘`;
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ NOTABLE FEATURE:                                            â•‘`;
                    
                    const featureLines = settlement.notable_feature.match(/.{1,58}/g) || [settlement.notable_feature];
                    featureLines.forEach(line => {
                        html += `
â•‘ ${line.padEnd(58)}â•‘`;
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ LOCAL TAVERN:                                               â•‘`;
                    
                    const tavernLines = settlement.local_tavern.match(/.{1,58}/g) || [settlement.local_tavern];
                    tavernLines.forEach(line => {
                        html += `
â•‘ ${line.padEnd(58)}â•‘`;
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ LOCAL POWER:                                                â•‘`;
                    
                    const powerLines = settlement.local_power.match(/.{1,58}/g) || [settlement.local_power];
                    powerLines.forEach(line => {
                        html += `
â•‘ ${line.padEnd(58)}â•‘`;
                    });
                    
                    // Add settlement layout if available
                    if (data.settlement_art || data.settlement_layout) {
                        html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ SETTLEMENT LAYOUT:                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£`;
                        
                        const layoutContent = data.settlement_art || data.settlement_layout;
                        const layoutLines = layoutContent.split('\n');
                        layoutLines.forEach(line => {
                            if (line.trim()) {
                                // Center the layout line within the box
                                const displayLine = line.substring(0, 58).padEnd(58);
                                html += `
â•‘ ${displayLine}â•‘`;
                            }
                        });
                    }
                    
                    // Add settlement layout if present (separate from art)
                    if (data.settlement_layout && data.settlement_layout !== 'No settlement layout' && data.settlement_layout !== data.settlement_art) {
                        html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ SETTLEMENT LAYOUT:                                          â•‘`;
                        const layoutLines = data.settlement_layout.split('\n');
                        layoutLines.forEach(line => {
                            html += `
â•‘ ${line.padEnd(58)}â•‘`;
                        });
                    }
                    
                    html += `
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                </pre>
                            </div>
                        </div>
                    `;
                    
                    mapContainer.innerHTML = html;
                } else {
                    showMapErrorState(hexCode);
                }
            })
            .catch(error => {
                console.error('ERROR LOADING SETTLEMENT:', error);
                showMapErrorState(hexCode);
            });
    }



    function displayHexContent(data, hexCode) {
        const modalContainer = document.getElementById('modalContainer');
        
        let html = '';
        if (data.exists) {
            html = generateHexModalHTML(data, hexCode);
        } else {
            html = generateEmptyHexHTML(hexCode);
        }
        
        modalContainer.innerHTML = html;
    }

    function generateHexModalHTML(data, hexCode) {
        const terrain = data.terrain || 'unknown';
        const terrainName = data.terrain_name || terrain.charAt(0).toUpperCase() + terrain.slice(1);
        const encounter = data.encounter || 'Unknown encounter';
        const denizen = data.denizen || 'No denizen information';
        const notableFeature = data.notable_feature || 'No notable features';
        const atmosphere = data.atmosphere || 'Unknown atmosphere';
        
        // Generate ASCII terrain art
        const asciiTerrain = getAsciiTerrain(terrain);
        
        // Build the HTML string
        let html = `
            <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                    <pre style="font-family: 'pixelify-sans', monospace; font-size: 11px; line-height: 1.2; color: var(--mork-cyan); margin: 0; white-space: pre-wrap; word-wrap: break-word;">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    HEX ${hexCode} - ${terrainName.toUpperCase().padEnd(50)}â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ TERRAIN: ${terrainName.padEnd(50)}â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ TERRAIN ART:                                                â•‘`;
        
        // Add ASCII terrain art
        const terrainLines = asciiTerrain.split('\n');
        terrainLines.forEach(line => {
            html += `
â•‘ ${line.padEnd(58)}â•‘`;
        });
        
        html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ENCOUNTER:                                                  â•‘`;
        
        // Split encounter into lines
        const encounterLines = encounter.match(/.{1,58}/g) || [encounter];
        encounterLines.forEach(line => {
            html += `
â•‘ ${line.padEnd(58)}â•‘`;
        });
        
        html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ DENIZEN:                                                    â•‘`;
        
        // Split denizen into lines
        const denizenLines = denizen.match(/.{1,58}/g) || [denizen];
        denizenLines.forEach(line => {
            html += `
â•‘ ${line.padEnd(58)}â•‘`;
        });
        
        html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ NOTABLE FEATURES:                                           â•‘`;
        
        // Split notable features into lines
        const featureLines = notableFeature.match(/.{1,58}/g) || [notableFeature];
        featureLines.forEach(line => {
            html += `
â•‘ ${line.padEnd(58)}â•‘`;
        });
        
        html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ATMOSPHERE:                                                 â•‘`;
        
        // Split atmosphere into lines
        const atmosphereLines = atmosphere.match(/.{1,58}/g) || [atmosphere];
        atmosphereLines.forEach(line => {
            html += `
â•‘ ${line.padEnd(58)}â•‘`;
        });
        
        // Add beast-specific details
        if (data.is_beast && data.beast_type) {
            html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ BEAST DETAILS:                                              â•‘`;
            
            if (data.beast_type) {
                const beastTypeLines = data.beast_type.match(/.{1,58}/g) || [data.beast_type];
                beastTypeLines.forEach(line => {
                    html += `
â•‘ Type: ${line.padEnd(53)}â•‘`;
                });
            }
            
            if (data.beast_feature) {
                const beastFeatureLines = data.beast_feature.match(/.{1,58}/g) || [data.beast_feature];
                beastFeatureLines.forEach(line => {
                    html += `
â•‘ Feature: ${line.padEnd(50)}â•‘`;
                });
            }
            
            if (data.beast_behavior) {
                const beastBehaviorLines = data.beast_behavior.match(/.{1,58}/g) || [data.beast_behavior];
                beastBehaviorLines.forEach(line => {
                    html += `
â•‘ Behavior: ${line.padEnd(48)}â•‘`;
                });
            }
        }
        
        // Add dungeon-specific details
        if (data.is_dungeon && data.dungeon_type) {
            html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ DUNGEON DETAILS:                                            â•‘`;
            
            if (data.dungeon_type) {
                const dungeonTypeLines = data.dungeon_type.match(/.{1,58}/g) || [data.dungeon_type];
                dungeonTypeLines.forEach(line => {
                    html += `
â•‘ Type: ${line.padEnd(53)}â•‘`;
                });
            }
            
            if (data.danger) {
                const dangerLines = data.danger.match(/.{1,58}/g) || [data.danger];
                dangerLines.forEach(line => {
                    html += `
â•‘ Danger: ${line.padEnd(51)}â•‘`;
                });
            }
            
            if (data.treasure) {
                const treasureLines = data.treasure.match(/.{1,58}/g) || [data.treasure];
                treasureLines.forEach(line => {
                    html += `
â•‘ Treasure: ${line.padEnd(49)}â•‘`;
                });
            }
        }
        
        // Add NPC-specific details
        if (data.is_npc && data.name) {
            html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ NPC DETAILS:                                                â•‘`;
            
            if (data.name) {
                const nameLines = data.name.match(/.{1,58}/g) || [data.name];
                nameLines.forEach(line => {
                    html += `
â•‘ Name: ${line.padEnd(53)}â•‘`;
                });
            }
            
            if (data.denizen_type) {
                const typeLines = data.denizen_type.match(/.{1,58}/g) || [data.denizen_type];
                typeLines.forEach(line => {
                    html += `
â•‘ Type: ${line.padEnd(53)}â•‘`;
                });
            }
            
            if (data.motivation) {
                const motivationLines = data.motivation.match(/.{1,58}/g) || [data.motivation];
                motivationLines.forEach(line => {
                    html += `
â•‘ Motivation: ${line.padEnd(47)}â•‘`;
                });
            }
            
            if (data.feature) {
                const featureLines = data.feature.match(/.{1,58}/g) || [data.feature];
                featureLines.forEach(line => {
                    html += `
â•‘ Feature: ${line.padEnd(50)}â•‘`;
                });
            }
            
            if (data.demeanor) {
                const demeanorLines = data.demeanor.match(/.{1,58}/g) || [data.demeanor];
                demeanorLines.forEach(line => {
                    html += `
â•‘ Demeanor: ${line.padEnd(49)}â•‘`;
                });
            }
            
            if (data.carries) {
                const carriesLines = data.carries.match(/.{1,58}/g) || [data.carries];
                carriesLines.forEach(line => {
                    html += `
â•‘ Carries: ${line.padEnd(50)}â•‘`;
                });
            }
        }
        
        // Add sea encounter details
        if (data.is_sea_encounter && data.encounter_type) {
            html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ SEA ENCOUNTER DETAILS:                                      â•‘`;
            
            if (data.encounter_type) {
                const encounterTypeLines = data.encounter_type.match(/.{1,58}/g) || [data.encounter_type];
                encounterTypeLines.forEach(line => {
                    html += `
â•‘ Type: ${line.padEnd(53)}â•‘`;
                });
            }
        }
        
        // Add threat level if present
        if (data.threat_level && data.threat_level !== 'Unknown threat level') {
            html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ THREAT LEVEL:                                               â•‘`;
            
            const threatLines = data.threat_level.match(/.{1,58}/g) || [data.threat_level];
            threatLines.forEach(line => {
                html += `
â•‘ ${line.padEnd(58)}â•‘`;
            });
        }
        
        // Add territory if present
        if (data.territory && data.territory !== 'No territory claimed') {
            html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ TERRITORY:                                                  â•‘`;
            
            const territoryLines = data.territory.match(/.{1,58}/g) || [data.territory];
            territoryLines.forEach(line => {
                html += `
â•‘ ${line.padEnd(58)}â•‘`;
            });
        }
        
        // Add loot if present
        if (data.loot && data.loot.description) {
            html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ LOOT FOUND:                                                 â•‘`;
            
            const lootDesc = data.loot.description || data.loot.full_description || 'Unknown loot';
            const lootLines = lootDesc.match(/.{1,58}/g) || [lootDesc];
            lootLines.forEach(line => {
                html += `
â•‘ ${line.padEnd(58)}â•‘`;
            });
            
            if (data.loot.magical_effect) {
                html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ MAGICAL EFFECT:                                             â•‘`;
                
                const magicalLines = data.loot.magical_effect.match(/.{1,58}/g) || [data.loot.magical_effect];
                magicalLines.forEach(line => {
                    html += `
â•‘ ${line.padEnd(58)}â•‘`;
                });
            }
        }
        
        // Add scroll/ancient knowledge if present
        if (data.scroll && data.scroll.description) {
            html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ANCIENT KNOWLEDGE:                                          â•‘`;
            
            const scrollDesc = data.scroll.description || data.scroll.full_description || 'Unknown knowledge';
            const scrollLines = scrollDesc.match(/.{1,58}/g) || [scrollDesc];
            scrollLines.forEach(line => {
                html += `
â•‘ ${line.padEnd(58)}â•‘`;
            });
        }
        
        html += `
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    </pre>
                </div>
            </div>
        `;
        
        return html;
    }

    function generateEmptyHexHTML(hexCode) {
        return `
            <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                    <pre style="font-family: 'pixelify-sans', monospace; font-size: 11px; line-height: 1.2; color: var(--mork-cyan); margin: 0; white-space: pre-wrap; word-wrap: break-word;">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    HEX ${hexCode} - EMPTY                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                              â•‘
â•‘  NO CONTENT GENERATED                                        â•‘
â•‘                                                              â•‘
â•‘  This hex has no content yet.                               â•‘
â•‘  Click "GENERATE CONTENT" to create encounters              â•‘
â•‘  and details for this location.                             â•‘
â•‘                                                              â•‘
â•‘  The dying lands await your exploration...                  â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    </pre>
                    <div class="text-center mt-4">
                        <button class="btn btn-mork-borg" onclick="generateHexContent('${hexCode}')">GENERATE CONTENT</button>
                    </div>
                            </div>
                        </div>
                    `;
    }

    function getAsciiTerrain(terrain) {
        const terrainArt = {
            'mountain': `    /\\   /\\   /\\
   /  \\_/  \\_/  \\
  /            \\
 /              \\`,
            'forest': `      /\\      /\\
     /  \\    /  \\
    /____\\  /____\\
      ||      ||`,
            'coast': `   ~   ~   ~   ~
 ~   ~   ~   ~
   ~   ~   ~   ~`,
            'plains': `  .  .  .  .  .
 .  .  .  .  .
  .  .  .  .  .`,
            'swamp': `  # # # # # #
 # # # # # # #
  # # # # # #`,
            'desert': `  ~~~~~~~~~~~
 ~~~~~.~~~~~
  ~~~~~~~~~~~`
        };
        
        return terrainArt[terrain] || terrainArt['plains'];
    }


    

    
    function restoreMap() {
        const mapContainer = document.querySelector('.map-container');
        const originalContent = mapContainer.getAttribute('data-original-content');
        if (originalContent) {
            mapContainer.innerHTML = originalContent;
            // Restore hex selection after returning to map
            if (currentHex) {
                const hexElement = document.querySelector(`[data-hex="${currentHex}"]`);
                if (hexElement) {
                    hexElement.classList.add('selected');
                }
            }
        } else {
            window.location.reload();
        }
    }
    
    function generateHexContent() {
        if (!currentHex) return;
        
        fetch('/api/generate-hex', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hex: currentHex })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showHexDetails(currentHex);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                alert('FAILED TO GENERATE CONTENT: ' + data.error);
            }
        })
        .catch(error => {
            console.error('ERROR GENERATING HEX:', error);
            alert('ERROR GENERATING HEX CONTENT');
        });
    }
    
    function generateFullMap() {
        if (confirm('GENERATE CONTENT FOR THE ENTIRE MAP? THIS MAY TAKE A WHILE...')) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'â³ GENERATING...';
            btn.disabled = true;
            
            fetch('/api/generate-full-map', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`GENERATED ${data.count} HEXES!`);
                    window.location.reload();
                } else {
                    alert('FAILED TO GENERATE MAP: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR GENERATING MAP:', error);
                alert('ERROR GENERATING FULL MAP');
            })
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }
    }
    
    function resetContinent() {
        if (confirm('ğŸš¨ RESET ENTIRE CONTINENT? ğŸš¨\n\nTHIS WILL DELETE ALL GENERATED CONTENT AND CREATE A COMPLETELY FRESH MAP.\n\nTHIS ACTION CANNOT BE UNDONE!')) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ğŸ”„ RESETTING...';
            btn.disabled = true;
            
            // Disable all other buttons during reset
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(button => button.disabled = true);
            
            fetch('/api/reset-continent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`âœ… ${data.message}`);
                    window.location.reload();
                } else {
                    alert('âŒ FAILED TO RESET CONTINENT: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ERROR RESETTING CONTINENT:', error);
                alert('âŒ ERROR RESETTING CONTINENT');
            })
            .finally(() => {
                // Re-enable all buttons
                allButtons.forEach(button => button.disabled = false);
                btn.textContent = originalText;
            });
        }
    }
    
    function showTerrainOverview() {
        // Show loading state in right panel
        showLoadingState();
        
        fetch('/api/terrain-overview')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const [width, height] = data.dimensions;
                    const modalContainer = document.getElementById('modalContainer');
                    
                    let html = `
                        <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <pre style="font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.2; color: var(--mork-cyan); margin: 0; white-space: pre-wrap; word-wrap: break-word;">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸ—ºï¸ TERRAIN OVERVIEW                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                              â•‘
â•‘  TERRAIN MAP:                                                â•‘
â•‘                                                              â•‘`;
                    
                    // Add terrain map
                    const mapLines = data.terrain_map.split('\n');
                    mapLines.forEach(line => {
                        html += `
â•‘ ${line.padEnd(58)}â•‘`;
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ“Š TERRAIN STATISTICS:                                      â•‘
â•‘                                                              â•‘`;
                    
                    for (const key in data.distribution) {
                        if (!data.distribution.hasOwnProperty(key)) continue;
                        const terrain = String(key);
                        const count = data.distribution[key];
                        const percentage = ((count / (width * height)) * 100).toFixed(1);
                        const terrainSymbol = getTerrainSymbol(terrain);
                        const terrainName = terrain.charAt(0).toUpperCase() + terrain.slice(1);
                        const statLine = `${terrainSymbol} ${terrainName}: ${count} HEXES (${percentage}%)`;
                        const paddedLine = statLine.padEnd(58);
                        html += `
â•‘ ${paddedLine}â•‘`;
                    }
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ—ºï¸ MAP INFO:                                               â•‘
â•‘                                                              â•‘
â•‘  DIMENSIONS: ${width}Ã—${height}${' '.repeat(58 - (width + 'Ã—' + height).length)}â•‘
â•‘  TOTAL HEXES: ${width * height}${' '.repeat(58 - String(width * height).length)}â•‘
â•‘  LORE INTEGRATION: âœ… ACTIVE${' '.repeat(58 - 'LORE INTEGRATION: âœ… ACTIVE'.length)}â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                </pre>
                            </div>
                        </div>
                    `;
                    
                    modalContainer.innerHTML = html;
                } else {
                    showErrorState('terrain-overview');
                }
            })
            .catch(error => {
                console.error('ERROR LOADING TERRAIN OVERVIEW:', error);
                showErrorState('terrain-overview');
            });
    }
    
    function showLoreOverview() {
        // Show loading state in right panel
        showLoadingState();
        
        fetch('/api/lore-overview')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modalContainer = document.getElementById('modalContainer');
                    
                    let html = `
                        <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <pre style="font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.2; color: var(--mork-cyan); margin: 0; white-space: pre-wrap; word-wrap: break-word;">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸ“œ MÃ–RK BORG LORE                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                              â•‘
â•‘  ğŸ° MAJOR CITIES (${data.major_cities}):                        â•‘
â•‘                                                              â•‘`;
                    
                    data.cities_data.forEach(city => {
                        const cityLine = `  ${city.name} (${city.hex_code}) - ${city.region}`;
                        const paddedLine = cityLine.padEnd(58);
                        html += `
â•‘ ${paddedLine}â•‘`;
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  âš”ï¸ MAJOR FACTIONS (${data.factions}):                         â•‘
â•‘                                                              â•‘`;
                    
                    data.factions_data.forEach(faction => {
                        const factionLine = `  ${faction.name} (${faction.influence})`;
                        const paddedLine = factionLine.padEnd(58);
                        html += `
â•‘ ${paddedLine}â•‘`;
                        
                        const regionsLine = `    Active in: ${faction.regions.join(', ')}`;
                        const paddedRegionsLine = regionsLine.padEnd(58);
                        html += `
â•‘ ${paddedRegionsLine}â•‘`;
                    });
                    
                    html += `
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ² GAME MASTER NOTE:                                        â•‘
â•‘                                                              â•‘
â•‘  LORE INTEGRATION: THIS LORE IS INTEGRATED INTO              â•‘
â•‘  HEX GENERATION. CITIES AND FACTIONS INFLUENCE              â•‘
â•‘  CONTENT IN THEIR REGIONS.                                   â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                </pre>
                            </div>
                        </div>
                    `;
                    
                    modalContainer.innerHTML = html;
                } else {
                    showErrorState('lore-overview');
                }
            })
            .catch(error => {
                console.error('ERROR LOADING LORE OVERVIEW:', error);
                showErrorState('lore-overview');
            });
    }
    
    function showCityOverlays() {
        // Show loading state in right panel
        showLoadingState();
        
        fetch('/api/city-overlays')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modalContainer = document.getElementById('modalContainer');
                    
                    let html = `
                        <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <h2 style="color: var(--mork-cyan); margin-bottom: 20px;">ğŸ° CITY OVERLAYS</h2>
                                <p style="color: var(--mork-white); margin-bottom: 20px;">
                                    Click on a city overlay to view its 5x5 hex grid in ASCII format.<br>
                                    Each hex contains randomly generated content based on MÃ¶rk Borg lore.
                                </p>
                    `;
                    
                    if (data.overlays.length === 0) {
                        html += `
                            <div style="padding: 40px; border: 1px solid var(--mork-cyan); margin: 20px 0;">
                                <p style="color: var(--mork-yellow);">No city overlay images found.</p>
                                <p style="color: var(--mork-white); font-size: 0.9em;">
                                    Add images to the <code>data/city_overlays/</code> directory to generate overlays.
                                </p>
                            </div>
                        `;
                    } else {
                        html += `<div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px;">`;
                        
                        data.overlays.forEach(overlay => {
                            html += `
                                <div class="city-overlay-card" style="border: 1px solid var(--mork-cyan); padding: 15px; cursor: pointer; transition: all 0.3s; background: rgba(0, 255, 255, 0.1);" 
                                     onclick="showCityOverlay('${overlay.name}')">
                                    <h4 style="color: var(--mork-cyan); margin-bottom: 10px;">${overlay.display_name}</h4>
                                    <p style="color: var(--mork-white); font-size: 0.9em;">
                                        File: ${overlay.filename}<br>
                                        Click to generate 5x5 hex grid overlay
                                    </p>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    modalContainer.innerHTML = html;
                    
                    // Add hover effects
                    document.querySelectorAll('.city-overlay-card').forEach(card => {
                        card.addEventListener('mouseenter', function() {
                            this.style.background = 'rgba(0, 255, 255, 0.2)';
                            this.style.transform = 'translateY(-2px)';
                        });
                        card.addEventListener('mouseleave', function() {
                            this.style.background = 'rgba(0, 255, 255, 0.1)';
                            this.style.transform = 'translateY(0)';
                        });
                    });
                } else {
                    showErrorState('city-overlays');
                }
            })
            .catch(error => {
                console.error('ERROR LOADING CITY OVERLAYS:', error);
                showErrorState('city-overlays');
            });
    }
    
    function showCityOverlay(overlayName) {
        // Show loading state
        showLoadingState();
        
        fetch(`/api/city-overlay/${overlayName}/ascii`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modalContainer = document.getElementById('modalContainer');
                    
                    let html = `
                        <div style="text-align: left; padding: 20px; height: 100%; overflow-y: auto;">
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <button class="btn btn-mork-borg" onclick="showCityOverlays()" style="margin-bottom: 10px;">â† BACK TO OVERLAYS</button>
                                    <button class="btn btn-mork-borg" onclick="loadCityOverlayGrid('${overlayName}')" style="margin-bottom: 10px;">ğŸ² INTERACTIVE GRID</button>
                                </div>
                                <pre style="font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.2; color: var(--mork-cyan); margin: 0; white-space: pre-wrap; word-wrap: break-word;">
${data.ascii}
                                </pre>
                            </div>
                        </div>
                    `;
                    
                    modalContainer.innerHTML = html;
                } else {
                    showErrorState('city-overlay');
                }
            })
            .catch(error => {
                console.error('ERROR LOADING CITY OVERLAY:', error);
                showErrorState('city-overlay');
            });
    }
    
    function loadCityOverlayGrid(overlayName) {
        // Show loading state
        showLoadingState();
        
        fetch(`/api/city-overlay/${overlayName}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modalContainer = document.getElementById('modalContainer');
                    const overlay = data.overlay;
                    
                    let html = `
                        <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <div style="margin-bottom: 20px;">
                                    <button class="btn btn-mork-borg" onclick="showCityOverlay('${overlayName}')" style="margin-bottom: 10px;">â† BACK TO ASCII</button>
                                    <h3 style="color: var(--mork-cyan); margin: 10px 0;">${overlay.display_name}</h3>
                                    <p style="color: var(--mork-white); font-size: 0.9em;">Interactive 5x5 Hex Grid - Click hexes for details</p>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(5, 80px); gap: 5px; justify-content: center; margin: 20px 0;">
                    `;
                    
                    for (let row = 0; row < 5; row++) {
                        for (let col = 0; col < 5; col++) {
                            const hexId = `${row}_${col}`;
                            const hexData = overlay.hex_grid[hexId];
                            const content = hexData.content;
                            const symbol = content.type.charAt(0).toUpperCase();
                            
                            html += `
                                <div class="city-hex" 
                                     style="width: 80px; height: 80px; border: 2px solid var(--mork-cyan); 
                                            background: rgba(0, 255, 255, 0.1); display: flex; 
                                            align-items: center; justify-content: center; 
                                            cursor: pointer; transition: all 0.3s; position: relative;"
                                     onclick="showCityHexDetails('${overlayName}', '${hexId}')"
                                     title="${content.name}">
                                    <div style="text-align: center;">
                                        <div style="color: var(--mork-cyan); font-size: 24px; font-weight: bold;">${symbol}</div>
                                        <div style="color: var(--mork-white); font-size: 10px;">${row+1},${col+1}</div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    html += `
                                </div>
                                
                                <div style="margin-top: 20px; text-align: left; font-size: 0.9em; color: var(--mork-white);">
                                    <strong>Legend:</strong><br>
                                    D=District, B=Building, S=Street, L=Landmark, M=Market<br>
                                    T=Temple, V=Tavern, G=Guild, R=Residence, U=Ruins
                                </div>
                                
                                <div id="hex-details" style="margin-top: 20px; min-height: 200px; border: 1px solid var(--mork-cyan); padding: 15px; text-align: left; background: rgba(0, 255, 255, 0.05);">
                                    <p style="color: var(--mork-cyan); text-align: center;">Click a hex above to view its details</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    modalContainer.innerHTML = html;
                    
                    // Add hover effects to hexes
                    document.querySelectorAll('.city-hex').forEach(hex => {
                        hex.addEventListener('mouseenter', function() {
                            this.style.background = 'rgba(0, 255, 255, 0.3)';
                            this.style.transform = 'scale(1.1)';
                        });
                        hex.addEventListener('mouseleave', function() {
                            this.style.background = 'rgba(0, 255, 255, 0.1)';
                            this.style.transform = 'scale(1)';
                        });
                    });
                } else {
                    showErrorState('city-overlay-grid');
                }
            })
            .catch(error => {
                console.error('ERROR LOADING CITY OVERLAY GRID:', error);
                showErrorState('city-overlay-grid');
            });
    }
    
    function showCityHexDetails(overlayName, hexId) {
        fetch(`/api/city-overlay/${overlayName}/hex/${hexId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const hexDetailsDiv = document.getElementById('hex-details');
                    const hex = data.hex;
                    const content = hex.content;
                    
                    let html = `
                        <h4 style="color: var(--mork-cyan); margin-bottom: 15px;">
                            ${content.name} [${hex.row+1},${hex.col+1}]
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--mork-yellow);">Type:</strong> ${content.type.charAt(0).toUpperCase() + content.type.slice(1)}<br>
                            <strong style="color: var(--mork-yellow);">Position:</strong> ${content.position_type}
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--mork-yellow);">Description:</strong><br>
                            <span style="color: var(--mork-white);">${content.description}</span>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--mork-yellow);">Encounter:</strong><br>
                            <span style="color: var(--mork-white);">${content.encounter}</span>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--mork-yellow);">Atmosphere:</strong><br>
                            <span style="color: var(--mork-white);">${content.atmosphere}</span>
                        </div>
                    `;
                    
                    if (content.random_table && content.random_table.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: var(--mork-yellow);">Random Events:</strong><br>
                                <div style="font-family: 'Courier New', monospace; font-size: 0.9em; color: var(--mork-white);">
                        `;
                        
                        content.random_table.forEach(event => {
                            html += `<div style="margin: 5px 0;">${event}</div>`;
                        });
                        
                        html += `</div></div>`;
                    }
                    
                    if (content.npcs && content.npcs.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: var(--mork-yellow);">NPCs:</strong><br>
                                <span style="color: var(--mork-white);">${content.npcs.join(', ')}</span>
                            </div>
                        `;
                    }
                    
                    if (content.treasures && content.treasures.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: var(--mork-yellow);">Treasures:</strong><br>
                                <span style="color: var(--mork-white);">${content.treasures.join(', ')}</span>
                            </div>
                        `;
                    }
                    
                    if (content.threats && content.threats.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: var(--mork-yellow);">Threats:</strong><br>
                                <span style="color: var(--mork-white);">${content.threats.join(', ')}</span>
                            </div>
                        `;
                    }
                    
                    if (content.notable_features && content.notable_features.length > 0) {
                        html += `
                            <div>
                                <strong style="color: var(--mork-yellow);">Notable Features:</strong><br>
                                <span style="color: var(--mork-white);">${content.notable_features.join(', ')}</span>
                            </div>
                        `;
                    }
                    
                    hexDetailsDiv.innerHTML = html;
                } else {
                    console.error('Error loading hex details');
                }
            })
            .catch(error => {
                console.error('ERROR LOADING HEX DETAILS:', error);
            });
    }
    
    function showCityOverlayInMap(hexCode) {
        // Extract city name from hex code using lore database
        showMapLoadingState();
        
        // First, get city information to determine the city name
        fetch(`/api/city/${hexCode}`)
            .then(response => response.json())
            .then(cityData => {
                if (cityData.success) {
                    const cityName = cityData.city.name.toLowerCase().replace(/\s+/g, '_');
                    return showCityOverlayGridInMap(cityName, hexCode);
                } else {
                    // Fallback: try galgenbeck for testing
                    return showCityOverlayGridInMap('galgenbeck', hexCode);
                }
            })
            .catch(error => {
                console.error('Error determining city name:', error);
                // Fallback: try galgenbeck for testing
                showCityOverlayGridInMap('galgenbeck', hexCode);
            });
    }
    
    function showCityOverlayGridInMap(overlayName, hexCode) {
        // Show loading state
        showMapLoadingState();
        
        fetch(`/api/city-overlay/${overlayName}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const overlay = data.overlay;
                    const mapContainer = document.querySelector('.map-container');
                    
                    let html = `
                        <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                            <div class="mb-4">
                                <button class="btn btn-mork-borg btn-warning me-2" onclick="showCityDetailsInMap('${hexCode}')">â† RETURN TO CITY</button>
                                <button class="btn btn-mork-borg" onclick="showCityOverlayAsciiInMap('${overlayName}', '${hexCode}')" style="margin-left: 10px;">ğŸ“œ ASCII VIEW</button>
                            </div>
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <h3 style="color: var(--mork-cyan); margin: 10px 0;">${overlay.display_name}</h3>
                                <p style="color: var(--mork-white); font-size: 0.9em; margin-bottom: 20px;">Interactive 5x5 Hex Grid - Click hexes for details</p>
                                
                                <div style="display: grid; grid-template-columns: repeat(5, 80px); gap: 5px; justify-content: center; margin: 20px 0;">
                    `;
                    
                    for (let row = 0; row < 5; row++) {
                        for (let col = 0; col < 5; col++) {
                            const hexId = `${row}_${col}`;
                            const hexData = overlay.hex_grid[hexId];
                            const content = hexData.content;
                            const symbol = content.type.charAt(0).toUpperCase();
                            
                            html += `
                                <div class="city-hex" 
                                     style="width: 80px; height: 80px; border: 2px solid var(--mork-cyan); 
                                            background: rgba(0, 255, 255, 0.1); display: flex; 
                                            align-items: center; justify-content: center; 
                                            cursor: pointer; transition: all 0.3s; position: relative;"
                                     onclick="showCityHexDetailsInMap('${overlayName}', '${hexId}')"
                                     title="${content.name}">
                                    <div style="text-align: center;">
                                        <div style="color: var(--mork-cyan); font-size: 24px; font-weight: bold;">${symbol}</div>
                                        <div style="color: var(--mork-white); font-size: 10px;">${row+1},${col+1}</div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    html += `
                                </div>
                                
                                <div style="margin-top: 20px; text-align: left; font-size: 0.9em; color: var(--mork-white);">
                                    <strong>Legend:</strong><br>
                                    D=District, B=Building, S=Street, L=Landmark, M=Market<br>
                                    T=Temple, V=Tavern, G=Guild, R=Residence, U=Ruins
                                </div>
                            </div>
                        </div>
                    `;
                    
                    mapContainer.innerHTML = html;
                    
                    // Add hover effects to hexes
                    document.querySelectorAll('.city-hex').forEach(hex => {
                        hex.addEventListener('mouseenter', function() {
                            this.style.background = 'rgba(0, 255, 255, 0.3)';
                            this.style.transform = 'scale(1.1)';
                        });
                        hex.addEventListener('mouseleave', function() {
                            this.style.background = 'rgba(0, 255, 255, 0.1)';
                            this.style.transform = 'scale(1)';
                        });
                    });
                } else {
                    showMapErrorState('city-overlay-grid');
                }
            })
            .catch(error => {
                console.error('ERROR LOADING CITY OVERLAY GRID:', error);
                showMapErrorState('city-overlay-grid');
            });
    }
    
    function showCityOverlayAsciiInMap(overlayName, hexCode) {
        // Show loading state
        showMapLoadingState();
        
        fetch(`/api/city-overlay/${overlayName}/ascii`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const mapContainer = document.querySelector('.map-container');
                    
                    let html = `
                        <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                            <div class="mb-4">
                                <button class="btn btn-mork-borg btn-warning me-2" onclick="showCityOverlayGridInMap('${overlayName}', '${hexCode}')">â† BACK TO GRID</button>
                                <button class="btn btn-mork-borg" onclick="showCityDetailsInMap('${hexCode}')" style="margin-left: 10px;">ğŸ° RETURN TO CITY</button>
                            </div>
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <pre style="font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.2; color: var(--mork-cyan); margin: 0; white-space: pre-wrap; word-wrap: break-word;">
${data.ascii}
                                </pre>
                            </div>
                        </div>
                    `;
                    
                    mapContainer.innerHTML = html;
                } else {
                    showMapErrorState('city-overlay-ascii');
                }
            })
            .catch(error => {
                console.error('ERROR LOADING CITY OVERLAY ASCII:', error);
                showMapErrorState('city-overlay-ascii');
            });
    }
    
    function showCityHexDetailsInMap(overlayName, hexId) {
        fetch(`/api/city-overlay/${overlayName}/hex/${hexId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modalContainer = document.getElementById('modalContainer');
                    const hex = data.hex;
                    const content = hex.content;
                    
                    let html = `
                        <div style="text-align: center; padding: 20px; height: 100%; overflow-y: auto;">
                            <div style="background: var(--mork-black); border: 2px solid var(--mork-cyan); padding: 20px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                <h4 style="color: var(--mork-cyan); margin-bottom: 15px;">
                                    ${content.name} [${hex.row+1},${hex.col+1}]
                                </h4>
                                
                                <div style="margin-bottom: 15px; text-align: left;">
                                    <strong style="color: var(--mork-yellow);">Type:</strong> ${content.type.charAt(0).toUpperCase() + content.type.slice(1)}<br>
                                    <strong style="color: var(--mork-yellow);">Position:</strong> ${content.position_type}
                                </div>
                                
                                <div style="margin-bottom: 15px; text-align: left;">
                                    <strong style="color: var(--mork-yellow);">Description:</strong><br>
                                    <span style="color: var(--mork-white);">${content.description}</span>
                                </div>
                                
                                <div style="margin-bottom: 15px; text-align: left;">
                                    <strong style="color: var(--mork-yellow);">Encounter:</strong><br>
                                    <span style="color: var(--mork-white);">${content.encounter}</span>
                                </div>
                                
                                <div style="margin-bottom: 15px; text-align: left;">
                                    <strong style="color: var(--mork-yellow);">Atmosphere:</strong><br>
                                    <span style="color: var(--mork-white);">${content.atmosphere}</span>
                                </div>
                    `;
                    
                    if (content.random_table && content.random_table.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px; text-align: left;">
                                <strong style="color: var(--mork-yellow);">Random Events:</strong><br>
                                <div style="font-family: 'Courier New', monospace; font-size: 0.9em; color: var(--mork-white);">
                        `;
                        
                        content.random_table.forEach(event => {
                            html += `<div style="margin: 5px 0;">${event}</div>`;
                        });
                        
                        html += `</div></div>`;
                    }
                    
                    if (content.npcs && content.npcs.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px; text-align: left;">
                                <strong style="color: var(--mork-yellow);">NPCs:</strong><br>
                                <span style="color: var(--mork-white);">${content.npcs.join(', ')}</span>
                            </div>
                        `;
                    }
                    
                    if (content.treasures && content.treasures.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px; text-align: left;">
                                <strong style="color: var(--mork-yellow);">Treasures:</strong><br>
                                <span style="color: var(--mork-white);">${content.treasures.join(', ')}</span>
                            </div>
                        `;
                    }
                    
                    if (content.threats && content.threats.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px; text-align: left;">
                                <strong style="color: var(--mork-yellow);">Threats:</strong><br>
                                <span style="color: var(--mork-white);">${content.threats.join(', ')}</span>
                            </div>
                        `;
                    }
                    
                    if (content.notable_features && content.notable_features.length > 0) {
                        html += `
                            <div style="text-align: left;">
                                <strong style="color: var(--mork-yellow);">Notable Features:</strong><br>
                                <span style="color: var(--mork-white);">${content.notable_features.join(', ')}</span>
                            </div>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    modalContainer.innerHTML = html;
                } else {
                    console.error('Error loading hex details');
                }
            })
            .catch(error => {
                console.error('ERROR LOADING HEX DETAILS:', error);
            });
    }
    
    function getTerrainSymbol(terrain) {
        const symbols = {
            'mountain': '^', 'forest': 'â™ ', 'coast': '~',
            'plains': '.', 'swamp': '#', 'unknown': '?'
        };
        return symbols[terrain] || '?';
    }
    
    </script>
</body>
</html>