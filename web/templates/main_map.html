<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è The Dying Lands - Interactive Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    body {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d1b2e 100%);
        color: #e0e0e0;
        font-family: 'Courier New', monospace;
    }
    
    .map-container {
        background: #0a0a0a;
        border: 2px solid #444;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
    }
    
    .hex-grid {
        font-family: 'Courier New', monospace;
        font-size: 11px;
        line-height: 1.1;
        overflow: auto;
        max-height: 70vh;
        background: #111;
        padding: 15px;
        border-radius: 5px;
        text-align: center;
        white-space: nowrap;
    }
    
    .hex-cell {
        cursor: pointer;
        padding: 1px 2px;
        border-radius: 2px;
        transition: all 0.2s;
        display: inline-block;
        width: 16px;
        text-align: center;
        margin-right: 0px;
    }
    
    .hex-cell:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.2);
    }
    
    .major-city {
        color: #FFD700 !important;
        font-weight: bold;
        text-shadow: 0 0 5px #FFD700;
    }
    
    .terrain-mountain { color: #8D6E63; }
    .terrain-forest { color: #4CAF50; }
    .terrain-coast { color: #2196F3; }
    .terrain-plains { color: #FFC107; }
    .terrain-swamp { color: #795548; }
    .terrain-unknown { color: #9E9E9E; }
    
    .has-content {
        font-weight: bold;
        opacity: 1;
    }
    
    .no-content {
        opacity: 0.6;
    }
    
    .control-panel {
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .city-card {
        background: linear-gradient(135deg, #2a2a2a, #3a2a3a);
        border: 1px solid #555;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: transform 0.2s;
    }
    
    .city-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
    }
    
    .modal-content {
        background: #2a2a2a;
        color: #e0e0e0;
        border: 1px solid #555;
    }
    
    .modal-header {
        border-bottom: 1px solid #555;
    }
    
    .modal-footer {
        border-top: 1px solid #555;
    }
    
    .badge {
        font-size: 0.8em;
    }
    
    .legend {
        background: rgba(0, 0, 0, 0.8);
        border-radius: 5px;
        padding: 10px;
        font-size: 0.9em;
    }
    
    .map-row {
        display: block;
        text-align: left;
        margin: 0 auto;
        width: fit-content;
    }
    
    .row-number {
        display: inline-block;
        width: 30px;
        text-align: right;
        margin-right: 5px;
        color: #666;
    }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="text-center py-3">
            <h1 class="mb-0">üó∫Ô∏è The Dying Lands</h1>
            <p class="text-muted">Interactive Hex Map - {{ map_width }}√ó{{ map_height }} ({{ total_hexes }} hexes)</p>
        </header>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="row">
                <div class="col-md-8">
                    <div class="btn-group me-2" role="group">
                        <button class="btn btn-warning btn-sm" onclick="showTerrainOverview()">üó∫Ô∏è Terrain</button>
                        <button class="btn btn-info btn-sm" onclick="showLoreOverview()">üìú Lore</button>
                        <button class="btn btn-secondary btn-sm" onclick="showLegend()">üóÇÔ∏è Legend</button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-success btn-sm" onclick="generateFullMap()">‚ö° Generate All</button>
                        <button class="btn btn-danger btn-sm" onclick="resetContinent()">üîÑ Reset Continent</button>
                        <button class="btn btn-primary btn-sm" onclick="zoomIn()">üîç+</button>
                        <button class="btn btn-primary btn-sm" onclick="zoomOut()">üîç-</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">
                        Click hexes to view/generate content<br>
                        <span class="major-city">‚óÜ</span> = Major Cities
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Major Cities Overview -->
        <div class="row mb-3" style="display: none;">
            <div class="col-12">
                <h5>üè∞ Major Cities</h5>
                <div class="row">
                    {% for city in major_cities %}
                    <div class="col-md-4 col-lg-3">
                        <div class="city-card card" onclick="showCityDetails('{{ city.hex_code }}')">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">{{ city.name }}</h6>
                                <small class="text-muted">
                                    {{ city.hex_code }} - {{ city.region.title() }}<br>
                                    Pop: {{ city.population }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- ASCII Map -->
        <div class="map-container">
            <div class="hex-grid" id="map-grid">
                <!-- Column headers -->
                <div class="text-center mb-2">
                    <span style="margin-right: 20px;"></span>
                    {% for x in range(1, map_width + 1) %}
                        {% if x <= 9 %}
                            <span style="margin-right: 4px; font-size: 9px; display: inline-block; width: 12px; text-align: center;">0{{ x }}</span>
                        {% else %}
                            <span style="margin-right: 4px; font-size: 9px; display: inline-block; width: 12px; text-align: center;">{{ x }}</span>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Map rows -->
                {% for y in range(1, map_height + 1) %}
                <div class="map-row">
                    <span class="row-number">{{ "%02d"|format(y) }}</span>
                    {% for x in range(1, map_width + 1) %}
                        {% set hex_code = "%02d%02d"|format(x, y) %}
                        {% set hex_data = ascii_map[hex_code] %}
                        <span class="hex-cell {{ hex_data.css_class }} {{ 'has-content' if hex_data.has_content else 'no-content' }}"
                              onclick="showHexDetails('{{ hex_code }}')"
                              title="Hex {{ hex_code }}{% if hex_data.is_city %} - {{ hex_data.city_name }}{% endif %}">{{ hex_data.symbol }}</span>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Legend -->
        <div class="legend" id="legend">
            <h6>üóÇÔ∏è Map Legend</h6>
            <div class="row">
                <div class="col-md-6">
                    <strong>Terrain:</strong><br>
                    <span class="terrain-mountain">^</span> Mountain &nbsp;
                    <span class="terrain-forest">‚ô†</span> Forest &nbsp;
                    <span class="terrain-coast">~</span> Coast<br>
                    <span class="terrain-plains">.</span> Plains &nbsp;
                    <span class="terrain-swamp">#</span> Swamp
                </div>
                <div class="col-md-6">
                    <strong>Locations:</strong><br>
                    <span class="major-city">‚óÜ</span> Major Cities<br>
                    <strong>Bold</strong> = Has Content
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hex Details Modal -->
    <div class="modal fade" id="hexModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hexModalTitle">Hex Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="hexModalBody">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="generateHexContent()">Generate Content</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- City Details Modal -->
    <div class="modal fade" id="cityModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cityModalTitle">City Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="cityModalBody">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Terrain Overview Modal -->
    <div class="modal fade" id="terrainModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üó∫Ô∏è Terrain Overview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="terrainModalBody">
                    Loading...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lore Overview Modal -->
    <div class="modal fade" id="loreModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìú M√∂rk Borg Lore</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="loreModalBody">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let currentHex = '';
    let mapZoom = 1;
    
    function showHexDetails(hexCode) {
        currentHex = hexCode;
        
        fetch(`/api/hex/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('hexModalTitle').textContent = data.title;
                
                if (data.is_major_city) {
                    showCityDetails(hexCode);
                    return;
                }
                
                let html = '';
                if (data.exists) {
                    html = data.html || `<p>${data.description || 'No description available'}</p>`;
                } else {
                    html = `<p>No content generated for hex ${hexCode}</p>`;
                }
                
                document.getElementById('hexModalBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('hexModal')).show();
            })
            .catch(error => {
                console.error('Error loading hex:', error);
                document.getElementById('hexModalBody').innerHTML = '<p class="text-danger">Error loading hex content</p>';
                new bootstrap.Modal(document.getElementById('hexModal')).show();
            });
    }
    
    function showCityDetails(hexCode) {
        fetch(`/api/city/${hexCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const city = data.city;
                    document.getElementById('cityModalTitle').textContent = city.name;
                    
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üó∫Ô∏è City Map</h6>
                                <pre style="background:#111; color:#e0e0e0; padding:15px; border-radius:5px; font-size:11px; line-height:1.1; overflow:auto; max-height:400px;">${data.city_map}</pre>
                            </div>
                            <div class="col-md-6">
                                <h6>üè∞ City Information</h6>
                                <p><strong>Location:</strong> Hex ${hexCode} (${city.region.charAt(0).toUpperCase() + city.region.slice(1)})</p>
                                <p><strong>Population:</strong> ${city.population}</p>
                                <p><strong>Description:</strong> ${city.description}</p>
                                <p><strong>Atmosphere:</strong> ${city.atmosphere}</p>
                                
                                <h6 class="mt-3">Notable Features</h6>
                                <ul style="font-size:0.9em;">
                    `;
                    
                    city.notable_features.forEach(feature => {
                        html += `<li>${feature}</li>`;
                    });
                    
                    html += `
                                </ul>
                                
                                <h6 class="mt-3">Key NPCs</h6>
                                <div class="d-flex flex-wrap gap-2">
                    `;
                    
                    city.key_npcs.forEach(npc => {
                        html += `<span class="badge bg-info">${npc}</span>`;
                    });
                    
                    html += `
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>üè∞ Regional NPCs</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                    `;
                    
                    data.regional_npcs.forEach(npc => {
                        html += `<span class="badge bg-secondary">${npc}</span>`;
                    });
                    
                    html += `
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>‚öîÔ∏è Active Factions</h6>
                    `;
                    
                    data.factions.forEach(faction => {
                        const influenceColors = {
                            'religious': 'warning',
                            'apocalyptic': 'danger',
                            'political': 'primary',
                            'biological': 'success',
                            'magical': 'info'
                        };
                        const badgeColor = influenceColors[faction.influence] || 'secondary';
                        
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <h6 class="mb-1" style="font-size:0.9em;">${faction.name} <span class="badge bg-${badgeColor}">${faction.influence}</span></h6>
                                    <small class="text-muted">${faction.description}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('cityModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('cityModal')).show();
                } else {
                    alert('Error loading city details: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error loading city:', error);
                alert('Error loading city details');
            });
    }
    
    function generateHexContent() {
        if (!currentHex) return;
        
        fetch('/api/generate-hex', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hex: currentHex })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showHexDetails(currentHex);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                alert('Failed to generate content: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error generating hex:', error);
            alert('Error generating hex content');
        });
    }
    
    function generateFullMap() {
        if (confirm('Generate content for the entire map? This may take a while...')) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Generating...';
            btn.disabled = true;
            
            fetch('/api/generate-full-map', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Generated ${data.count} hexes!`);
                    window.location.reload();
                } else {
                    alert('Failed to generate map: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error generating map:', error);
                alert('Error generating full map');
            })
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }
    }
    
    function resetContinent() {
        if (confirm('üö® RESET ENTIRE CONTINENT? üö®\n\nThis will DELETE ALL generated content and create a completely fresh map.\n\nThis action cannot be undone!')) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'üîÑ Resetting...';
            btn.disabled = true;
            
            // Disable all other buttons during reset
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(button => button.disabled = true);
            
            fetch('/api/reset-continent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Failed to reset continent: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error resetting continent:', error);
                alert('‚ùå Error resetting continent');
            })
            .finally(() => {
                // Re-enable all buttons
                allButtons.forEach(button => button.disabled = false);
                btn.textContent = originalText;
            });
        }
    }
    
    function showTerrainOverview() {
        fetch('/api/terrain-overview')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const [width, height] = data.dimensions;
                    let html = `
                        <div class="row">
                            <div class="col-md-8">
                                <pre style="background:#111; color:#e0e0e0; padding:15px; border-radius:5px; font-size:10px; line-height:1.1; overflow:auto; max-height:60vh;">${data.terrain_map}</pre>
                            </div>
                            <div class="col-md-4">
                                <h6>üìä Terrain Statistics</h6>
                    `;
                    
                    for (const [terrain, count] of Object.entries(data.distribution)) {
                        const percentage = ((count / (width * height)) * 100).toFixed(1);
                        html += `<div class="mb-2">
                            <span class="terrain-${terrain}">${getTerrainSymbol(terrain)}</span>
                            <strong>${terrain.charAt(0).toUpperCase() + terrain.slice(1)}</strong>: 
                            ${count} hexes (${percentage}%)
                        </div>`;
                    }
                    
                    html += `
                                <hr>
                                <h6>üó∫Ô∏è Map Info</h6>
                                <div class="small">
                                    <strong>Dimensions:</strong> ${width}√ó${height}<br>
                                    <strong>Total Hexes:</strong> ${width * height}<br>
                                    <strong>Lore Integration:</strong> ‚úÖ Active
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('terrainModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('terrainModal')).show();
                } else {
                    alert('Error loading terrain overview: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error loading terrain overview:', error);
                alert('Error loading terrain overview');
            });
    }
    
    function showLoreOverview() {
        fetch('/api/lore-overview')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üè∞ Major Cities (${data.major_cities})</h6>
                    `;
                    
                    data.cities_data.forEach(city => {
                        html += `
                            <div class="card mb-2" onclick="showCityDetails('${city.hex_code}')" style="cursor:pointer;">
                                <div class="card-body py-2">
                                    <h6 class="mb-1">${city.name} <span class="badge bg-secondary">${city.hex_code}</span></h6>
                                    <small class="text-muted">${city.region} - ${city.population}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                            <div class="col-md-6">
                                <h6>‚öîÔ∏è Major Factions (${data.factions})</h6>
                    `;
                    
                    data.factions_data.forEach(faction => {
                        const influenceColors = {
                            'religious': 'warning',
                            'apocalyptic': 'danger',
                            'political': 'primary',
                            'biological': 'success',
                            'magical': 'info'
                        };
                        const badgeColor = influenceColors[faction.influence] || 'secondary';
                        
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <h6 class="mb-1">${faction.name} <span class="badge bg-${badgeColor}">${faction.influence}</span></h6>
                                    <small class="text-muted">Active in: ${faction.regions.join(', ')}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="alert alert-info">
                                <strong>üé≤ Game Master Note:</strong> This lore is integrated into hex generation. 
                                Cities and factions influence content in their regions.
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('loreModalBody').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('loreModal')).show();
                } else {
                    alert('Error loading lore overview: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error loading lore overview:', error);
                alert('Error loading lore overview');
            });
    }
    
    function getTerrainSymbol(terrain) {
        const symbols = {
            'mountain': '^', 'forest': '‚ô†', 'coast': '~',
            'plains': '.', 'swamp': '#', 'unknown': '?'
        };
        return symbols[terrain] || '?';
    }
    
    function zoomIn() {
        mapZoom = Math.min(mapZoom * 1.2, 3);
        applyZoom();
    }
    
    function zoomOut() {
        mapZoom = Math.max(mapZoom / 1.2, 0.5);
        applyZoom();
    }
    
    function applyZoom() {
        const mapElement = document.getElementById('map-grid');
        if (mapElement) {
            mapElement.style.transform = `scale(${mapZoom})`;
            mapElement.style.transformOrigin = 'top left';
        }
    }
    
    function showLegend() {
        document.getElementById('legend').scrollIntoView({ behavior: 'smooth' });
    }
    </script>
</body>
</html>